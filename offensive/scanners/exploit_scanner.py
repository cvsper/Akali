"""Exploit scanner for CVE lookup and exploit database integration."""

import re
import json
import requests
import subprocess
from typing import List, Dict, Any, Optional
from datetime import datetime
from pathlib import Path

import sys
sys.path.append(str(Path(__file__).parent.parent.parent))
from defensive.scanners.scanner_base import Scanner, Finding, Severity


class ExploitScanner(Scanner):
    """Scanner for exploit and CVE lookups."""

    def __init__(self):
        super().__init__("exploit-scanner")
        self.nvd_api_base = "https://services.nvd.nist.gov/rest/json/cves/2.0"
        self.timeout = 60

    def check_available(self) -> bool:
        """Check if required tools/APIs are available."""
        try:
            # Test NVD API connectivity
            response = requests.get(
                self.nvd_api_base,
                params={"resultsPerPage": 1},
                timeout=10
            )
            return response.status_code == 200
        except requests.RequestException:
            return False

    def scan(self, target: str) -> List[Finding]:
        """Not used for exploit scanner - use lookup_cve() instead."""
        return []

    def lookup_cve(self, cve_id: str) -> Optional[Dict[str, Any]]:
        """Look up CVE details from NVD.

        Args:
            cve_id: CVE identifier (e.g., CVE-2021-44228)

        Returns:
            CVE details dictionary or None
        """
        print(f"ü•∑ Looking up {cve_id}...")

        # Validate CVE format
        if not re.match(r'CVE-\d{4}-\d+', cve_id, re.IGNORECASE):
            print("‚ùå Invalid CVE format. Use: CVE-YYYY-NNNNN")
            return None

        cve_id = cve_id.upper()

        try:
            # Query NVD API
            url = f"{self.nvd_api_base}"
            params = {"cveId": cve_id}

            response = requests.get(url, params=params, timeout=30)

            if response.status_code != 200:
                print(f"‚ùå NVD API returned status {response.status_code}")
                return None

            data = response.json()

            if not data.get("vulnerabilities"):
                print(f"‚ùå {cve_id} not found in NVD database")
                return None

            vuln = data["vulnerabilities"][0]
            cve = vuln.get("cve", {})

            # Extract key information
            cve_info = {
                "id": cve_id,
                "description": self._get_description(cve),
                "published": cve.get("published", "Unknown"),
                "lastModified": cve.get("lastModified", "Unknown"),
                "cvss_v3": self._get_cvss_v3(cve),
                "cvss_v2": self._get_cvss_v2(cve),
                "severity": self._get_severity(cve),
                "cwe": self._get_cwe(cve),
                "references": self._get_references(cve),
                "affected": self._get_affected_products(cve)
            }

            # Search for exploits
            cve_info["exploits"] = self._search_exploits(cve_id)

            return cve_info

        except Exception as e:
            print(f"‚ùå Error looking up CVE: {e}")
            return None

    def _get_description(self, cve: Dict) -> str:
        """Extract CVE description."""
        descriptions = cve.get("descriptions", [])
        for desc in descriptions:
            if desc.get("lang") == "en":
                return desc.get("value", "No description available")
        return "No description available"

    def _get_cvss_v3(self, cve: Dict) -> Optional[Dict[str, Any]]:
        """Extract CVSS v3 score."""
        metrics = cve.get("metrics", {})
        cvss_v3 = metrics.get("cvssMetricV31", []) or metrics.get("cvssMetricV30", [])

        if cvss_v3:
            cvss_data = cvss_v3[0].get("cvssData", {})
            return {
                "baseScore": cvss_data.get("baseScore"),
                "baseSeverity": cvss_data.get("baseSeverity"),
                "vectorString": cvss_data.get("vectorString"),
                "attackVector": cvss_data.get("attackVector"),
                "attackComplexity": cvss_data.get("attackComplexity"),
                "privilegesRequired": cvss_data.get("privilegesRequired"),
                "userInteraction": cvss_data.get("userInteraction"),
                "confidentialityImpact": cvss_data.get("confidentialityImpact"),
                "integrityImpact": cvss_data.get("integrityImpact"),
                "availabilityImpact": cvss_data.get("availabilityImpact")
            }
        return None

    def _get_cvss_v2(self, cve: Dict) -> Optional[Dict[str, Any]]:
        """Extract CVSS v2 score."""
        metrics = cve.get("metrics", {})
        cvss_v2 = metrics.get("cvssMetricV2", [])

        if cvss_v2:
            cvss_data = cvss_v2[0].get("cvssData", {})
            return {
                "baseScore": cvss_data.get("baseScore"),
                "vectorString": cvss_data.get("vectorString"),
                "accessVector": cvss_data.get("accessVector"),
                "accessComplexity": cvss_data.get("accessComplexity"),
                "authentication": cvss_data.get("authentication")
            }
        return None

    def _get_severity(self, cve: Dict) -> str:
        """Determine overall severity."""
        cvss_v3 = self._get_cvss_v3(cve)
        if cvss_v3:
            return cvss_v3.get("baseSeverity", "UNKNOWN")

        cvss_v2 = self._get_cvss_v2(cve)
        if cvss_v2:
            score = cvss_v2.get("baseScore", 0)
            if score >= 7.0:
                return "HIGH"
            elif score >= 4.0:
                return "MEDIUM"
            else:
                return "LOW"

        return "UNKNOWN"

    def _get_cwe(self, cve: Dict) -> List[str]:
        """Extract CWE identifiers."""
        weaknesses = cve.get("weaknesses", [])
        cwes = []

        for weakness in weaknesses:
            for desc in weakness.get("description", []):
                value = desc.get("value", "")
                if value.startswith("CWE-"):
                    cwes.append(value)

        return cwes

    def _get_references(self, cve: Dict) -> List[Dict[str, str]]:
        """Extract reference URLs."""
        references = cve.get("references", [])
        refs = []

        for ref in references[:10]:  # Limit to 10 references
            refs.append({
                "url": ref.get("url", ""),
                "source": ref.get("source", ""),
                "tags": ref.get("tags", [])
            })

        return refs

    def _get_affected_products(self, cve: Dict) -> List[str]:
        """Extract affected products."""
        configurations = cve.get("configurations", [])
        products = set()

        for config in configurations:
            for node in config.get("nodes", []):
                for cpe_match in node.get("cpeMatch", []):
                    if cpe_match.get("vulnerable"):
                        cpe = cpe_match.get("criteria", "")
                        # Parse CPE format: cpe:2.3:a:vendor:product:version:...
                        parts = cpe.split(":")
                        if len(parts) >= 5:
                            vendor = parts[3]
                            product = parts[4]
                            version = parts[5] if len(parts) > 5 else "*"
                            products.add(f"{vendor}/{product} {version}")

        return list(products)[:20]  # Limit to 20 products

    def _search_exploits(self, cve_id: str) -> List[Dict[str, str]]:
        """Search for public exploits for this CVE."""
        exploits = []

        # Search Exploit-DB (searchsploit if available)
        try:
            result = subprocess.run(
                ["searchsploit", "--json", "--cve", cve_id],
                capture_output=True,
                text=True,
                timeout=30,
                check=False
            )

            if result.returncode == 0:
                try:
                    data = json.loads(result.stdout)
                    for exploit in data.get("RESULTS_EXPLOIT", []):
                        exploits.append({
                            "title": exploit.get("Title", ""),
                            "platform": exploit.get("Platform", ""),
                            "type": exploit.get("Type", ""),
                            "path": exploit.get("Path", ""),
                            "source": "Exploit-DB"
                        })
                except json.JSONDecodeError:
                    pass

        except (FileNotFoundError, subprocess.TimeoutExpired):
            # searchsploit not available
            pass

        # If no exploits found via searchsploit, check GitHub
        if not exploits:
            exploits.extend(self._search_github_exploits(cve_id))

        return exploits

    def _search_github_exploits(self, cve_id: str) -> List[Dict[str, str]]:
        """Search GitHub for exploit PoCs."""
        exploits = []

        try:
            # Search GitHub API
            url = "https://api.github.com/search/repositories"
            params = {
                "q": f"{cve_id} exploit OR poc",
                "sort": "stars",
                "order": "desc",
                "per_page": 5
            }

            response = requests.get(url, params=params, timeout=15)

            if response.status_code == 200:
                data = response.json()
                for repo in data.get("items", []):
                    exploits.append({
                        "title": repo.get("full_name", ""),
                        "description": repo.get("description", ""),
                        "url": repo.get("html_url", ""),
                        "stars": repo.get("stargazers_count", 0),
                        "source": "GitHub"
                    })

        except requests.RequestException:
            pass

        return exploits

    def print_cve_report(self, cve_info: Dict[str, Any]) -> None:
        """Print formatted CVE report."""
        print(f"\n{'=' * 80}")
        print(f"CVE Report: {cve_info['id']}")
        print(f"{'=' * 80}")

        print(f"\nüìã Description:")
        print(f"  {cve_info['description']}")

        print(f"\nüìÖ Timeline:")
        print(f"  Published: {cve_info['published']}")
        print(f"  Last Modified: {cve_info['lastModified']}")

        print(f"\n‚ö†Ô∏è  Severity: {cve_info['severity']}")

        # CVSS v3
        if cve_info['cvss_v3']:
            cvss3 = cve_info['cvss_v3']
            print(f"\nüìä CVSS v3.x Score: {cvss3['baseScore']} ({cvss3['baseSeverity']})")
            print(f"  Vector: {cvss3['vectorString']}")
            print(f"  Attack Vector: {cvss3['attackVector']}")
            print(f"  Attack Complexity: {cvss3['attackComplexity']}")
            print(f"  Privileges Required: {cvss3['privilegesRequired']}")
            print(f"  User Interaction: {cvss3['userInteraction']}")

        # CVSS v2
        elif cve_info['cvss_v2']:
            cvss2 = cve_info['cvss_v2']
            print(f"\nüìä CVSS v2 Score: {cvss2['baseScore']}")
            print(f"  Vector: {cvss2['vectorString']}")

        # CWE
        if cve_info['cwe']:
            print(f"\nüîç CWE: {', '.join(cve_info['cwe'])}")

        # Affected products
        if cve_info['affected']:
            print(f"\nüéØ Affected Products:")
            for product in cve_info['affected'][:10]:
                print(f"  - {product}")
            if len(cve_info['affected']) > 10:
                print(f"  ... and {len(cve_info['affected']) - 10} more")

        # Exploits
        if cve_info['exploits']:
            print(f"\nüí£ Known Exploits ({len(cve_info['exploits'])}):")
            for exploit in cve_info['exploits']:
                print(f"\n  [{exploit.get('source', 'Unknown')}] {exploit.get('title', 'Unknown')}")
                if exploit.get('url'):
                    print(f"    URL: {exploit['url']}")
                if exploit.get('description'):
                    print(f"    Description: {exploit['description']}")
                if exploit.get('stars'):
                    print(f"    ‚≠ê {exploit['stars']} stars")
        else:
            print(f"\n‚úÖ No public exploits found")

        # References
        if cve_info['references']:
            print(f"\nüîó References:")
            for ref in cve_info['references'][:5]:
                tags = f" [{', '.join(ref['tags'])}]" if ref['tags'] else ""
                print(f"  - {ref['url']}{tags}")

        print(f"\n{'=' * 80}\n")


def main():
    """CLI for exploit scanner."""
    import sys

    if len(sys.argv) < 2:
        print("Usage: python exploit_scanner.py <CVE-ID>")
        print("Example: python exploit_scanner.py CVE-2021-44228")
        sys.exit(1)

    cve_id = sys.argv[1].upper()

    scanner = ExploitScanner()

    if not scanner.check_available():
        print("‚ö†Ô∏è  Warning: NVD API not accessible. Results may be limited.")

    cve_info = scanner.lookup_cve(cve_id)

    if cve_info:
        scanner.print_cve_report(cve_info)
    else:
        print(f"‚ùå Failed to retrieve information for {cve_id}")
        sys.exit(1)


if __name__ == "__main__":
    main()
