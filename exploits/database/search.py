"""Main ExploitSearch class for unified exploit database search."""

from typing import List, Dict, Optional
from pathlib import Path

from .exploitdb import ExploitDBClient
from .github_pocs import GitHubPOCSearch
from .metasploit import MetasploitSearch


class ExploitSearch:
    """Unified exploit search across multiple sources."""

    def __init__(self):
        """Initialize exploit search clients."""
        self.exploitdb = ExploitDBClient()
        self.github = GitHubPOCSearch()
        self.metasploit = MetasploitSearch()

    def search_exploitdb(self, query: str) -> List[Dict]:
        """Search ExploitDB via searchsploit.

        Args:
            query: Search query string

        Returns:
            List of exploit dictionaries
        """
        return self.exploitdb.search(query)

    def search_github_pocs(self, query: str) -> List[Dict]:
        """Search GitHub for POC exploits.

        Args:
            query: Search query (CVE, keywords, etc.)

        Returns:
            List of POC dictionaries
        """
        return self.github.search(query)

    def search_metasploit(self, query: str) -> List[Dict]:
        """Search Metasploit modules.

        Args:
            query: Search query string

        Returns:
            List of module dictionaries
        """
        return self.metasploit.search(query)

    def search_all(self, query: str) -> Dict[str, List[Dict]]:
        """Search all exploit sources.

        Args:
            query: Search query string

        Returns:
            Dictionary with results from each source
        """
        return {
            'exploitdb': self.search_exploitdb(query),
            'github': self.search_github_pocs(query),
            'metasploit': self.search_metasploit(query)
        }

    def download_exploit(self, exploit_id: str, output_path: str) -> bool:
        """Download exploit by ID.

        Args:
            exploit_id: Exploit identifier (EDB-12345, URL, etc.)
            output_path: Path to save the exploit

        Returns:
            True if successful, False otherwise
        """
        # Determine source from ID format
        if exploit_id.startswith('EDB-'):
            return self.exploitdb.download_exploit(
                exploit_id.replace('EDB-', ''),
                output_path
            )
        elif 'github.com' in exploit_id:
            return self.github.download(exploit_id, output_path)
        else:
            # Invalid ID format
            return False

    def _format_exploitdb_result(self, result: Dict) -> Dict:
        """Format ExploitDB result to standard format.

        Args:
            result: Raw ExploitDB result

        Returns:
            Standardized result dictionary
        """
        return {
            'id': f"EDB-{result.get('EDB-ID', result.get('id', 'unknown'))}",
            'title': result.get('Title', result.get('title', 'Unknown')),
            'source': 'exploitdb',
            'date': result.get('Date', result.get('date')),
            'author': result.get('Author', result.get('author')),
            'type': result.get('Type', result.get('type')),
            'platform': result.get('Platform', result.get('platform')),
            'path': result.get('Path', result.get('path'))
        }
