"""ExploitDB integration via searchsploit."""

import json
import subprocess
import shutil
from typing import List, Dict, Optional
from pathlib import Path


class ExploitDBClient:
    """Client for searching ExploitDB via searchsploit."""

    def __init__(self):
        """Initialize ExploitDB client."""
        self.searchsploit_bin = "searchsploit"

    def check_available(self) -> bool:
        """Check if searchsploit is available.

        Returns:
            True if searchsploit is installed, False otherwise
        """
        try:
            result = subprocess.run(
                [self.searchsploit_bin, "--help"],
                capture_output=True,
                timeout=5
            )
            return result.returncode == 0
        except (FileNotFoundError, subprocess.TimeoutExpired):
            return False

    def search(self, query: str) -> List[Dict]:
        """Search ExploitDB by term.

        Args:
            query: Search query string

        Returns:
            List of exploit dictionaries
        """
        if not self.check_available():
            return []

        try:
            result = subprocess.run(
                [self.searchsploit_bin, "--json", query],
                capture_output=True,
                text=True,
                timeout=30
            )

            if result.returncode == 0 and result.stdout:
                return self._parse_output(result.stdout)

        except (subprocess.TimeoutExpired, Exception):
            pass

        return []

    def search_by_cve(self, cve_id: str) -> List[Dict]:
        """Search ExploitDB by CVE.

        Args:
            cve_id: CVE identifier (e.g., CVE-2021-1234)

        Returns:
            List of exploit dictionaries
        """
        if not self.check_available():
            return []

        try:
            result = subprocess.run(
                [self.searchsploit_bin, "--json", "--cve", cve_id],
                capture_output=True,
                text=True,
                timeout=30
            )

            if result.returncode == 0 and result.stdout:
                return self._parse_output(result.stdout)

        except (subprocess.TimeoutExpired, Exception):
            pass

        return []

    def get_exploit_path(self, edb_id: str) -> Optional[str]:
        """Get local filesystem path to exploit.

        Args:
            edb_id: ExploitDB ID (without EDB- prefix)

        Returns:
            Path to exploit file or None if not found
        """
        if not self.check_available():
            return None

        try:
            # Search by EDB ID
            result = subprocess.run(
                [self.searchsploit_bin, "--json", "--id", edb_id],
                capture_output=True,
                text=True,
                timeout=10
            )

            if result.returncode == 0 and result.stdout:
                results = self._parse_output(result.stdout)
                if results and 'path' in results[0]:
                    return results[0]['path']

        except (subprocess.TimeoutExpired, Exception):
            pass

        return None

    def download_exploit(self, edb_id: str, output_path: str) -> bool:
        """Download/copy exploit to specified path.

        Args:
            edb_id: ExploitDB ID (without EDB- prefix)
            output_path: Destination path

        Returns:
            True if successful, False otherwise
        """
        exploit_path = self.get_exploit_path(edb_id)

        if not exploit_path:
            return False

        try:
            # Copy exploit to output path
            shutil.copy2(exploit_path, output_path)
            return True
        except Exception:
            return False

    def _parse_output(self, json_output: str) -> List[Dict]:
        """Parse searchsploit JSON output.

        Args:
            json_output: JSON string from searchsploit

        Returns:
            List of standardized exploit dictionaries
        """
        try:
            data = json.loads(json_output)
            exploits = data.get('RESULTS_EXPLOIT', [])

            results = []
            for exploit in exploits:
                results.append({
                    'id': f"EDB-{exploit.get('EDB-ID', 'unknown')}",
                    'title': exploit.get('Title', 'Unknown'),
                    'source': 'exploitdb',
                    'date': exploit.get('Date'),
                    'author': exploit.get('Author'),
                    'type': exploit.get('Type'),
                    'platform': exploit.get('Platform'),
                    'path': exploit.get('Path')
                })

            return results

        except json.JSONDecodeError:
            return []
