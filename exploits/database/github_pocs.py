"""GitHub POC exploit search."""

import requests
from typing import List, Dict
from pathlib import Path


class GitHubPOCSearch:
    """Search GitHub for POC exploits."""

    def __init__(self, api_token: str = None):
        """Initialize GitHub search.

        Args:
            api_token: Optional GitHub API token for higher rate limits
        """
        self.api_base = "https://api.github.com"
        self.headers = {}
        if api_token:
            self.headers['Authorization'] = f'token {api_token}'

    def search(self, query: str, max_results: int = 10) -> List[Dict]:
        """Search GitHub repositories for POCs.

        Args:
            query: Search query (CVE, keywords, etc.)
            max_results: Maximum number of results to return

        Returns:
            List of POC dictionaries
        """
        try:
            # Add POC/exploit keywords to query
            search_query = f"{query} exploit OR poc"

            url = f"{self.api_base}/search/repositories"
            params = {
                'q': search_query,
                'sort': 'stars',
                'order': 'desc',
                'per_page': max_results
            }

            response = requests.get(
                url,
                params=params,
                headers=self.headers,
                timeout=15
            )

            if response.status_code == 200:
                data = response.json()
                return self._format_results(data.get('items', []))
            elif response.status_code == 403:
                # Rate limit exceeded
                return []

        except Exception:
            pass

        return []

    def search_code(self, query: str, max_results: int = 10) -> List[Dict]:
        """Search GitHub code for exploit files.

        Args:
            query: Search query
            max_results: Maximum number of results

        Returns:
            List of code file dictionaries
        """
        try:
            url = f"{self.api_base}/search/code"
            params = {
                'q': query,
                'per_page': max_results
            }

            response = requests.get(
                url,
                params=params,
                headers=self.headers,
                timeout=15
            )

            if response.status_code == 200:
                data = response.json()
                items = data.get('items', [])

                results = []
                for item in items:
                    results.append({
                        'repository': item.get('repository', {}).get('full_name'),
                        'path': item.get('path'),
                        'url': item.get('html_url'),
                        'source': 'github_code'
                    })
                return results

        except Exception:
            pass

        return []

    def download(self, url: str, output_path: str) -> bool:
        """Download POC file from GitHub.

        Args:
            url: GitHub URL (blob or raw)
            output_path: Destination path

        Returns:
            True if successful, False otherwise
        """
        try:
            # Convert blob URL to raw URL
            raw_url = self._convert_to_raw_url(url)

            response = requests.get(raw_url, timeout=30)

            if response.status_code == 200:
                Path(output_path).write_bytes(response.content)
                return True

        except Exception:
            pass

        return False

    def filter_by_stars(self, results: List[Dict], min_stars: int = 0) -> List[Dict]:
        """Filter results by minimum star count.

        Args:
            results: List of search results
            min_stars: Minimum number of stars

        Returns:
            Filtered results
        """
        return [r for r in results if r.get('stars', 0) >= min_stars]

    def _convert_to_raw_url(self, blob_url: str) -> str:
        """Convert GitHub blob URL to raw content URL.

        Args:
            blob_url: GitHub blob URL

        Returns:
            Raw content URL
        """
        # Convert: https://github.com/user/repo/blob/main/file.py
        # To: https://raw.githubusercontent.com/user/repo/main/file.py
        return blob_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/')

    def _format_results(self, items: List[Dict]) -> List[Dict]:
        """Format GitHub API results to standard format.

        Args:
            items: Raw GitHub API items

        Returns:
            Standardized result list
        """
        results = []
        for item in items:
            results.append({
                'id': item.get('full_name', '').replace('/', '-'),
                'title': item.get('full_name'),
                'description': item.get('description', ''),
                'url': item.get('html_url'),
                'stars': item.get('stargazers_count', 0),
                'created': item.get('created_at'),
                'updated': item.get('updated_at'),
                'source': 'github'
            })
        return results
