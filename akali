#!/usr/bin/env python3
"""Akali - The Security Sentinel CLI."""

import sys
import argparse
from pathlib import Path

# Add core to path
sys.path.append(str(Path.home() / "akali" / "core"))

from cli import AkaliCLI


def main():
    parser = argparse.ArgumentParser(
        description="Akali - The Security Sentinel",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Defensive Examples:
  akali scan .                    # Scan current directory
  akali scan ~/project            # Scan specific directory
  akali scan --secrets-only       # Run only secrets scanner
  akali findings list             # List all findings
  akali findings show AKALI-001   # Show finding details

Offensive Examples (requires authorization):
  akali attack https://example.com --web      # Web vulnerability scan
  akali attack 192.168.1.1 --network          # Network scan
  akali attack https://api.example.com --api  # API security scan
  akali attack https://example.com --full     # Full offensive scan
  akali exploit CVE-2021-44228                # CVE lookup

Status:
  akali status                    # Show Akali status

For more help: https://github.com/sevs/akali
        """
    )

    subparsers = parser.add_subparsers(dest="command", help="Commands")

    # Scan command
    scan_parser = subparsers.add_parser("scan", help="Run security scan")
    scan_parser.add_argument("target", help="Target directory or file to scan")
    scan_parser.add_argument("--secrets-only", action="store_true", help="Run only secrets scanner")
    scan_parser.add_argument("--deps-only", action="store_true", help="Run only dependency scanner")
    scan_parser.add_argument("--sast-only", action="store_true", help="Run only SAST scanner")

    # Findings command
    findings_parser = subparsers.add_parser("findings", help="Manage findings")
    findings_subparsers = findings_parser.add_subparsers(dest="findings_command")

    list_parser = findings_subparsers.add_parser("list", help="List findings")
    list_parser.add_argument("--open", action="store_true", help="Show only open findings")
    list_parser.add_argument("--closed", action="store_true", help="Show only closed findings")
    list_parser.add_argument("--critical", action="store_true", help="Show only critical findings")
    list_parser.add_argument("--high", action="store_true", help="Show only high severity findings")
    list_parser.add_argument("--scanner", help="Filter by scanner type")

    show_parser = findings_subparsers.add_parser("show", help="Show finding details")
    show_parser.add_argument("finding_id", help="Finding ID to show")

    # Attack command (offensive)
    attack_parser = subparsers.add_parser("attack", help="‚ö†Ô∏è  Run offensive security scan (requires authorization)")
    attack_parser.add_argument("target", help="Target URL, hostname, or IP")
    attack_parser.add_argument("--web", action="store_true", help="Web vulnerability scan")
    attack_parser.add_argument("--network", action="store_true", help="Network scan")
    attack_parser.add_argument("--api", action="store_true", help="API security scan")
    attack_parser.add_argument("--full", action="store_true", help="Full offensive scan (all attack types)")
    attack_parser.add_argument("--quick", action="store_true", help="Quick scan mode")
    attack_parser.add_argument("--ports", help="Port specification for network scan (e.g., 80,443)")
    attack_parser.add_argument("--wordlist", help="Wordlist path for API endpoint discovery")

    # Exploit command
    exploit_parser = subparsers.add_parser("exploit", help="Look up CVE and exploit information")
    exploit_parser.add_argument("cve_id", help="CVE identifier (e.g., CVE-2021-44228)")

    # Schedule command (autonomous)
    schedule_parser = subparsers.add_parser("schedule", help="Manage scheduled jobs")
    schedule_subparsers = schedule_parser.add_subparsers(dest="schedule_command")

    schedule_subparsers.add_parser("list", help="List scheduled jobs")

    schedule_run_parser = schedule_subparsers.add_parser("run", help="Run a job immediately")
    schedule_run_parser.add_argument("job_id", help="Job ID to run")

    # Daemon command (autonomous)
    daemon_parser = subparsers.add_parser("daemon", help="Manage autonomous daemons")
    daemon_subparsers = daemon_parser.add_subparsers(dest="daemon_command")

    daemon_start_parser = daemon_subparsers.add_parser("start", help="Start a daemon")
    daemon_start_parser.add_argument("type", choices=["watch", "health"], help="Daemon type")

    daemon_stop_parser = daemon_subparsers.add_parser("stop", help="Stop a daemon")
    daemon_stop_parser.add_argument("type", choices=["watch", "health"], help="Daemon type")

    daemon_subparsers.add_parser("status", help="Show daemon status")

    # Alert command (autonomous)
    alert_parser = subparsers.add_parser("alert", help="Manage alerts")
    alert_subparsers = alert_parser.add_subparsers(dest="alert_command")

    alert_send_parser = alert_subparsers.add_parser("send", help="Send alert for a finding")
    alert_send_parser.add_argument("finding_id", help="Finding ID")
    alert_send_parser.add_argument("--agent", help="Override agent ID")

    alert_list_parser = alert_subparsers.add_parser("list", help="List alerts")
    alert_list_parser.add_argument("--pending", action="store_true", help="Show only pending alerts")

    alert_ack_parser = alert_subparsers.add_parser("ack", help="Acknowledge an alert")
    alert_ack_parser.add_argument("alert_id", help="Alert ID")

    # Triage command (autonomous)
    triage_parser = subparsers.add_parser("triage", help="Automated triage")
    triage_parser.add_argument("finding_id", help="Finding ID to triage")

    # Intel command (Phase 4)
    intel_parser = subparsers.add_parser("intel", help="Threat intelligence operations")
    intel_subparsers = intel_parser.add_subparsers(dest="intel_command")

    intel_cve_parser = intel_subparsers.add_parser("cve-check", help="Check for new CVEs")
    intel_cve_parser.add_argument("--hours", type=int, default=24, help="Hours to look back (default: 24)")

    intel_lookup_parser = intel_subparsers.add_parser("cve-lookup", help="Lookup specific CVE")
    intel_lookup_parser.add_argument("cve_id", help="CVE identifier")

    intel_subparsers.add_parser("scan-deps", help="Scan all projects for dependencies")

    intel_impact_parser = intel_subparsers.add_parser("impact", help="Analyze CVE impact")
    intel_impact_parser.add_argument("cve_id", help="CVE identifier")

    intel_subparsers.add_parser("threat-feed", help="Show threat intelligence feed")

    intel_breach_parser = intel_subparsers.add_parser("breach-check", help="Check for breached emails")
    intel_breach_parser.add_argument("email", help="Email address to check")

    # Metrics command (Phase 4)
    metrics_parser = subparsers.add_parser("metrics", help="Security metrics and observatory")
    metrics_subparsers = metrics_parser.add_subparsers(dest="metrics_command")

    metrics_subparsers.add_parser("score", help="Show security scorecard")

    metrics_history_parser = metrics_subparsers.add_parser("history", help="Show score history")
    metrics_history_parser.add_argument("--days", type=int, default=30, help="Days to show (default: 30)")

    metrics_subparsers.add_parser("observatory", help="Show MTTD/MTTR metrics")

    # Dashboard command (Phase 4)
    dashboard_parser = subparsers.add_parser("dashboard", help="Web dashboard operations")
    dashboard_subparsers = dashboard_parser.add_subparsers(dest="dashboard_command")

    dashboard_start_parser = dashboard_subparsers.add_parser("start", help="Start dashboard server")
    dashboard_start_parser.add_argument("--port", type=int, default=8765, help="Port to run on (default: 8765)")
    dashboard_start_parser.add_argument("--host", default="127.0.0.1", help="Host to bind to (default: 127.0.0.1)")

    dashboard_subparsers.add_parser("status", help="Check dashboard status")

    # Status command
    subparsers.add_parser("status", help="Show Akali status")

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        return

    cli = AkaliCLI()

    try:
        if args.command == "scan":
            # Determine which scanners to run
            scanner_types = []
            if args.secrets_only:
                scanner_types = ["secrets"]
            elif args.deps_only:
                scanner_types = ["dependencies"]
            elif args.sast_only:
                scanner_types = ["sast"]

            print(f"ü•∑ Akali: Scanning {args.target}...\n")
            findings = cli.scan(args.target, scanner_types if scanner_types else None)

            if findings:
                print(f"\n‚ö†Ô∏è  Found {len(findings)} security issues")
                print(f"   Run 'akali findings list' to see details")
                sys.exit(1)
            else:
                print(f"\n‚úÖ No security issues found")
                sys.exit(0)

        elif args.command == "findings":
            if args.findings_command == "list":
                status = None
                if args.open:
                    status = "open"
                elif args.closed:
                    status = "closed"

                severity = None
                if args.critical:
                    severity = "critical"
                elif args.high:
                    severity = "high"

                cli.list_findings(status=status, severity=severity, scanner=args.scanner)

            elif args.findings_command == "show":
                cli.show_finding(args.finding_id)

            else:
                findings_parser.print_help()

        elif args.command == "attack":
            # Determine attack type
            if args.web:
                attack_type = "web"
            elif args.network:
                attack_type = "network"
            elif args.api:
                attack_type = "api"
            elif args.full:
                attack_type = "full"
            else:
                # Default to full if no specific type
                attack_type = "full"

            print(f"ü•∑ Akali: Offensive scan on {args.target}\n")

            # Pass additional kwargs
            kwargs = {}
            if args.ports:
                kwargs["ports"] = args.ports
            if args.wordlist:
                kwargs["wordlist"] = args.wordlist

            findings = cli.attack(args.target, attack_type=attack_type, quick=args.quick, **kwargs)

            if findings:
                print(f"\n‚ö†Ô∏è  Found {len(findings)} security issues")
                print(f"   Run 'akali findings list' to see details")
                sys.exit(1)
            else:
                print(f"\n‚úÖ No critical vulnerabilities found")
                sys.exit(0)

        elif args.command == "exploit":
            cli.exploit(args.cve_id)

        elif args.command == "schedule":
            if args.schedule_command == "list":
                cli.schedule_list()
            elif args.schedule_command == "run":
                cli.schedule_run(args.job_id)
            else:
                schedule_parser.print_help()

        elif args.command == "daemon":
            if args.daemon_command == "start":
                cli.daemon_start(args.type)
            elif args.daemon_command == "stop":
                cli.daemon_stop(args.type)
            elif args.daemon_command == "status":
                cli.daemon_status()
            else:
                daemon_parser.print_help()

        elif args.command == "alert":
            if args.alert_command == "send":
                cli.alert_send(args.finding_id, agent_id=args.agent if hasattr(args, 'agent') else None)
            elif args.alert_command == "list":
                cli.alert_list(pending=args.pending)
            elif args.alert_command == "ack":
                cli.alert_ack(args.alert_id)
            else:
                alert_parser.print_help()

        elif args.command == "triage":
            cli.triage_finding(args.finding_id)

        elif args.command == "intel":
            if args.intel_command == "cve-check":
                cli.intel_cve_check(hours=args.hours)
            elif args.intel_command == "cve-lookup":
                cli.intel_cve_lookup(args.cve_id)
            elif args.intel_command == "scan-deps":
                cli.intel_scan_deps()
            elif args.intel_command == "impact":
                cli.intel_impact(args.cve_id)
            elif args.intel_command == "threat-feed":
                cli.intel_threat_feed()
            elif args.intel_command == "breach-check":
                cli.intel_breach_check(args.email)
            else:
                intel_parser.print_help()

        elif args.command == "metrics":
            if args.metrics_command == "score" or not args.metrics_command:
                cli.metrics_score()
            elif args.metrics_command == "history":
                cli.metrics_history(days=args.days)
            elif args.metrics_command == "observatory":
                cli.metrics_observatory()
            else:
                metrics_parser.print_help()

        elif args.command == "dashboard":
            if args.dashboard_command == "start":
                cli.dashboard_start(host=args.host, port=args.port)
            elif args.dashboard_command == "status":
                cli.dashboard_status()
            else:
                dashboard_parser.print_help()

        elif args.command == "status":
            cli.status()

    except KeyboardInterrupt:
        print("\n\nüëã Interrupted by user")
        sys.exit(130)
    except Exception as e:
        print(f"\n‚ùå Error: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
