#!/usr/bin/env python3
"""Akali - The Security Sentinel CLI."""

import sys
import argparse
from pathlib import Path

# Add core to path
sys.path.append(str(Path.home() / "akali" / "core"))

from cli import AkaliCLI


def main():
    parser = argparse.ArgumentParser(
        description="Akali - The Security Sentinel",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Defensive Examples:
  akali scan .                    # Scan current directory
  akali scan ~/project            # Scan specific directory
  akali scan --secrets-only       # Run only secrets scanner
  akali findings list             # List all findings
  akali findings show AKALI-001   # Show finding details

Offensive Examples (requires authorization):
  akali attack https://example.com --web      # Web vulnerability scan
  akali attack 192.168.1.1 --network          # Network scan
  akali attack https://api.example.com --api  # API security scan
  akali attack https://example.com --full     # Full offensive scan
  akali exploit CVE-2021-44228                # CVE lookup

Status:
  akali status                    # Show Akali status

For more help: https://github.com/sevs/akali
        """
    )

    subparsers = parser.add_subparsers(dest="command", help="Commands")

    # Scan command
    scan_parser = subparsers.add_parser("scan", help="Run security scan")
    scan_parser.add_argument("target", help="Target directory or file to scan")
    scan_parser.add_argument("--secrets-only", action="store_true", help="Run only secrets scanner")
    scan_parser.add_argument("--deps-only", action="store_true", help="Run only dependency scanner")
    scan_parser.add_argument("--sast-only", action="store_true", help="Run only SAST scanner")

    # Findings command
    findings_parser = subparsers.add_parser("findings", help="Manage findings")
    findings_subparsers = findings_parser.add_subparsers(dest="findings_command")

    list_parser = findings_subparsers.add_parser("list", help="List findings")
    list_parser.add_argument("--open", action="store_true", help="Show only open findings")
    list_parser.add_argument("--closed", action="store_true", help="Show only closed findings")
    list_parser.add_argument("--critical", action="store_true", help="Show only critical findings")
    list_parser.add_argument("--high", action="store_true", help="Show only high severity findings")
    list_parser.add_argument("--scanner", help="Filter by scanner type")

    show_parser = findings_subparsers.add_parser("show", help="Show finding details")
    show_parser.add_argument("finding_id", help="Finding ID to show")

    # Attack command (offensive)
    attack_parser = subparsers.add_parser("attack", help="‚ö†Ô∏è  Run offensive security scan (requires authorization)")
    attack_parser.add_argument("target", help="Target URL, hostname, or IP")
    attack_parser.add_argument("--web", action="store_true", help="Web vulnerability scan")
    attack_parser.add_argument("--network", action="store_true", help="Network scan")
    attack_parser.add_argument("--api", action="store_true", help="API security scan")
    attack_parser.add_argument("--full", action="store_true", help="Full offensive scan (all attack types)")
    attack_parser.add_argument("--quick", action="store_true", help="Quick scan mode")
    attack_parser.add_argument("--ports", help="Port specification for network scan (e.g., 80,443)")
    attack_parser.add_argument("--wordlist", help="Wordlist path for API endpoint discovery")

    # Exploit command
    exploit_parser = subparsers.add_parser("exploit", help="Look up CVE and exploit information")
    exploit_parser.add_argument("cve_id", help="CVE identifier (e.g., CVE-2021-44228)")

    # Status command
    subparsers.add_parser("status", help="Show Akali status")

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        return

    cli = AkaliCLI()

    try:
        if args.command == "scan":
            # Determine which scanners to run
            scanner_types = []
            if args.secrets_only:
                scanner_types = ["secrets"]
            elif args.deps_only:
                scanner_types = ["dependencies"]
            elif args.sast_only:
                scanner_types = ["sast"]

            print(f"ü•∑ Akali: Scanning {args.target}...\n")
            findings = cli.scan(args.target, scanner_types if scanner_types else None)

            if findings:
                print(f"\n‚ö†Ô∏è  Found {len(findings)} security issues")
                print(f"   Run 'akali findings list' to see details")
                sys.exit(1)
            else:
                print(f"\n‚úÖ No security issues found")
                sys.exit(0)

        elif args.command == "findings":
            if args.findings_command == "list":
                status = None
                if args.open:
                    status = "open"
                elif args.closed:
                    status = "closed"

                severity = None
                if args.critical:
                    severity = "critical"
                elif args.high:
                    severity = "high"

                cli.list_findings(status=status, severity=severity, scanner=args.scanner)

            elif args.findings_command == "show":
                cli.show_finding(args.finding_id)

            else:
                findings_parser.print_help()

        elif args.command == "attack":
            # Determine attack type
            if args.web:
                attack_type = "web"
            elif args.network:
                attack_type = "network"
            elif args.api:
                attack_type = "api"
            elif args.full:
                attack_type = "full"
            else:
                # Default to full if no specific type
                attack_type = "full"

            print(f"ü•∑ Akali: Offensive scan on {args.target}\n")

            # Pass additional kwargs
            kwargs = {}
            if args.ports:
                kwargs["ports"] = args.ports
            if args.wordlist:
                kwargs["wordlist"] = args.wordlist

            findings = cli.attack(args.target, attack_type=attack_type, quick=args.quick, **kwargs)

            if findings:
                print(f"\n‚ö†Ô∏è  Found {len(findings)} security issues")
                print(f"   Run 'akali findings list' to see details")
                sys.exit(1)
            else:
                print(f"\n‚úÖ No critical vulnerabilities found")
                sys.exit(0)

        elif args.command == "exploit":
            cli.exploit(args.cve_id)

        elif args.command == "status":
            cli.status()

    except KeyboardInterrupt:
        print("\n\nüëã Interrupted by user")
        sys.exit(130)
    except Exception as e:
        print(f"\n‚ùå Error: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
