#!/usr/bin/env python3
"""Akali - The Security Sentinel CLI."""

import sys
import argparse
from pathlib import Path

# Add core to path
sys.path.append(str(Path.home() / "akali" / "core"))

from cli import AkaliCLI


def main():
    parser = argparse.ArgumentParser(
        description="Akali - The Security Sentinel",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Defensive Examples:
  akali scan .                    # Scan current directory
  akali scan ~/project            # Scan specific directory
  akali scan --secrets-only       # Run only secrets scanner
  akali findings list             # List all findings
  akali findings show AKALI-001   # Show finding details

Offensive Examples (requires authorization):
  akali attack https://example.com --web      # Web vulnerability scan
  akali attack 192.168.1.1 --network          # Network scan
  akali attack https://api.example.com --api  # API security scan
  akali attack https://example.com --full     # Full offensive scan
  akali exploit CVE-2021-44228                # CVE lookup

Vault Examples:
  akali vault health --mock                   # Check Vault status (mock mode)
  akali vault get app/database --mock         # Get secret from Vault
  akali vault set app/api '{"key":"val"}'     # Store secret in Vault
  akali vault scan /path/to/project           # Scan for hardcoded secrets
  akali vault rotate db-password --mock       # Rotate a secret

Training Examples:
  akali train list                            # List training modules
  akali train start owasp-01-injection        # Start OWASP training
  akali train progress --agent dommo          # View progress

Status:
  akali status                    # Show Akali status

For more help: https://github.com/sevs/akali
        """
    )

    subparsers = parser.add_subparsers(dest="command", help="Commands")

    # Scan command
    scan_parser = subparsers.add_parser("scan", help="Run security scan")
    scan_parser.add_argument("target", help="Target directory or file to scan")
    scan_parser.add_argument("--secrets-only", action="store_true", help="Run only secrets scanner")
    scan_parser.add_argument("--deps-only", action="store_true", help="Run only dependency scanner")
    scan_parser.add_argument("--sast-only", action="store_true", help="Run only SAST scanner")

    # Findings command
    findings_parser = subparsers.add_parser("findings", help="Manage findings")
    findings_subparsers = findings_parser.add_subparsers(dest="findings_command")

    list_parser = findings_subparsers.add_parser("list", help="List findings")
    list_parser.add_argument("--open", action="store_true", help="Show only open findings")
    list_parser.add_argument("--closed", action="store_true", help="Show only closed findings")
    list_parser.add_argument("--critical", action="store_true", help="Show only critical findings")
    list_parser.add_argument("--high", action="store_true", help="Show only high severity findings")
    list_parser.add_argument("--scanner", help="Filter by scanner type")

    show_parser = findings_subparsers.add_parser("show", help="Show finding details")
    show_parser.add_argument("finding_id", help="Finding ID to show")

    # Attack command (offensive)
    attack_parser = subparsers.add_parser("attack", help="‚ö†Ô∏è  Run offensive security scan (requires authorization)")
    attack_parser.add_argument("target", help="Target URL, hostname, or IP")
    attack_parser.add_argument("--web", action="store_true", help="Web vulnerability scan")
    attack_parser.add_argument("--network", action="store_true", help="Network scan")
    attack_parser.add_argument("--api", action="store_true", help="API security scan")
    attack_parser.add_argument("--full", action="store_true", help="Full offensive scan (all attack types)")
    attack_parser.add_argument("--quick", action="store_true", help="Quick scan mode")
    attack_parser.add_argument("--ports", help="Port specification for network scan (e.g., 80,443)")
    attack_parser.add_argument("--wordlist", help="Wordlist path for API endpoint discovery")

    # Exploit command
    exploit_parser = subparsers.add_parser("exploit", help="Look up CVE and exploit information")
    exploit_parser.add_argument("cve_id", help="CVE identifier (e.g., CVE-2021-44228)")

    # Schedule command (autonomous)
    schedule_parser = subparsers.add_parser("schedule", help="Manage scheduled jobs")
    schedule_subparsers = schedule_parser.add_subparsers(dest="schedule_command")

    schedule_subparsers.add_parser("list", help="List scheduled jobs")

    schedule_run_parser = schedule_subparsers.add_parser("run", help="Run a job immediately")
    schedule_run_parser.add_argument("job_id", help="Job ID to run")

    # Daemon command (autonomous)
    daemon_parser = subparsers.add_parser("daemon", help="Manage autonomous daemons")
    daemon_subparsers = daemon_parser.add_subparsers(dest="daemon_command")

    daemon_start_parser = daemon_subparsers.add_parser("start", help="Start a daemon")
    daemon_start_parser.add_argument("type", choices=["watch", "health"], help="Daemon type")

    daemon_stop_parser = daemon_subparsers.add_parser("stop", help="Stop a daemon")
    daemon_stop_parser.add_argument("type", choices=["watch", "health"], help="Daemon type")

    daemon_subparsers.add_parser("status", help="Show daemon status")

    # Alert command (autonomous)
    alert_parser = subparsers.add_parser("alert", help="Manage alerts")
    alert_subparsers = alert_parser.add_subparsers(dest="alert_command")

    alert_send_parser = alert_subparsers.add_parser("send", help="Send alert for a finding")
    alert_send_parser.add_argument("finding_id", help="Finding ID")
    alert_send_parser.add_argument("--agent", help="Override agent ID")

    alert_list_parser = alert_subparsers.add_parser("list", help="List alerts")
    alert_list_parser.add_argument("--pending", action="store_true", help="Show only pending alerts")

    alert_ack_parser = alert_subparsers.add_parser("ack", help="Acknowledge an alert")
    alert_ack_parser.add_argument("alert_id", help="Alert ID")

    # Triage command (autonomous)
    triage_parser = subparsers.add_parser("triage", help="Automated triage")
    triage_parser.add_argument("finding_id", help="Finding ID to triage")

    # Intel command (Phase 4)
    intel_parser = subparsers.add_parser("intel", help="Threat intelligence operations")
    intel_subparsers = intel_parser.add_subparsers(dest="intel_command")

    intel_cve_parser = intel_subparsers.add_parser("cve-check", help="Check for new CVEs")
    intel_cve_parser.add_argument("--hours", type=int, default=24, help="Hours to look back (default: 24)")

    intel_lookup_parser = intel_subparsers.add_parser("cve-lookup", help="Lookup specific CVE")
    intel_lookup_parser.add_argument("cve_id", help="CVE identifier")

    intel_subparsers.add_parser("scan-deps", help="Scan all projects for dependencies")

    intel_impact_parser = intel_subparsers.add_parser("impact", help="Analyze CVE impact")
    intel_impact_parser.add_argument("cve_id", help="CVE identifier")

    intel_subparsers.add_parser("threat-feed", help="Show threat intelligence feed")

    intel_breach_parser = intel_subparsers.add_parser("breach-check", help="Check for breached emails")
    intel_breach_parser.add_argument("email", help="Email address to check")

    # Metrics command (Phase 4)
    metrics_parser = subparsers.add_parser("metrics", help="Security metrics and observatory")
    metrics_subparsers = metrics_parser.add_subparsers(dest="metrics_command")

    metrics_subparsers.add_parser("score", help="Show security scorecard")

    metrics_history_parser = metrics_subparsers.add_parser("history", help="Show score history")
    metrics_history_parser.add_argument("--days", type=int, default=30, help="Days to show (default: 30)")

    metrics_subparsers.add_parser("observatory", help="Show MTTD/MTTR metrics")

    # Dashboard command (Phase 4)
    dashboard_parser = subparsers.add_parser("dashboard", help="Web dashboard operations")
    dashboard_subparsers = dashboard_parser.add_subparsers(dest="dashboard_command")

    dashboard_start_parser = dashboard_subparsers.add_parser("start", help="Start dashboard server")
    dashboard_start_parser.add_argument("--port", type=int, default=8765, help="Port to run on (default: 8765)")
    dashboard_start_parser.add_argument("--host", default="127.0.0.1", help="Host to bind to (default: 127.0.0.1)")

    dashboard_subparsers.add_parser("status", help="Check dashboard status")

    # Incident Response Commands (Phase 5)
    # Incident command
    incident_parser = subparsers.add_parser("incident", help="Incident management")
    incident_subparsers = incident_parser.add_subparsers(dest="incident_command")

    incident_create_parser = incident_subparsers.add_parser("create", help="Create new incident")
    incident_create_parser.add_argument("title", help="Incident title")
    incident_create_parser.add_argument("--severity", required=True, choices=["low", "medium", "high", "critical"], help="Severity level")
    incident_create_parser.add_argument("--description", help="Incident description")
    incident_create_parser.add_argument("--type", help="Incident type (sql_injection, data_breach, etc.)")
    incident_create_parser.add_argument("--systems", nargs="+", help="Affected systems")

    incident_list_parser = incident_subparsers.add_parser("list", help="List incidents")
    incident_list_parser.add_argument("--status", choices=["new", "active", "contained", "resolved", "closed"], help="Filter by status")
    incident_list_parser.add_argument("--severity", choices=["low", "medium", "high", "critical"], help="Filter by severity")

    incident_show_parser = incident_subparsers.add_parser("show", help="Show incident details")
    incident_show_parser.add_argument("incident_id", help="Incident ID")

    incident_update_parser = incident_subparsers.add_parser("update", help="Update incident status")
    incident_update_parser.add_argument("incident_id", help="Incident ID")
    incident_update_parser.add_argument("status", choices=["new", "active", "contained", "resolved", "closed"], help="New status")

    incident_close_parser = incident_subparsers.add_parser("close", help="Close incident")
    incident_close_parser.add_argument("incident_id", help="Incident ID")
    incident_close_parser.add_argument("resolution", help="Resolution summary")

    # War room command
    warroom_parser = subparsers.add_parser("war-room", help="War room operations")
    warroom_subparsers = warroom_parser.add_subparsers(dest="warroom_command")

    warroom_start_parser = warroom_subparsers.add_parser("start", help="Activate war room")
    warroom_start_parser.add_argument("incident_id", help="Incident ID")

    warroom_stop_parser = warroom_subparsers.add_parser("stop", help="Deactivate war room")
    warroom_stop_parser.add_argument("--resolution", help="Resolution summary")

    warroom_subparsers.add_parser("status", help="Show war room status")

    # Playbook command
    playbook_parser = subparsers.add_parser("playbook", help="Playbook operations")
    playbook_subparsers = playbook_parser.add_subparsers(dest="playbook_command")

    playbook_subparsers.add_parser("list", help="List available playbooks")

    playbook_run_parser = playbook_subparsers.add_parser("run", help="Run a playbook")
    playbook_run_parser.add_argument("playbook_id", help="Playbook ID")
    playbook_run_parser.add_argument("incident_id", help="Incident ID")

    playbook_status_parser = playbook_subparsers.add_parser("status", help="Check playbook status")
    playbook_status_parser.add_argument("run_id", help="Playbook run ID")

    # Post-mortem command
    postmortem_parser = subparsers.add_parser("post-mortem", help="Generate post-mortem report")
    postmortem_parser.add_argument("incident_id", help="Incident ID")
    postmortem_parser.add_argument("--output", help="Output file path")

    # Training commands
    train_parser = subparsers.add_parser("train", help="Security training")
    train_subparsers = train_parser.add_subparsers(dest="train_command")

    train_subparsers.add_parser("list", help="List training modules")

    train_start_parser = train_subparsers.add_parser("start", help="Start training module")
    train_start_parser.add_argument("module_id", help="Module ID")
    train_start_parser.add_argument("--agent", default="unknown", help="Agent ID")

    train_progress_parser = train_subparsers.add_parser("progress", help="View training progress")
    train_progress_parser.add_argument("--agent", default="unknown", help="Agent ID")

    train_cert_parser = train_subparsers.add_parser("certificate", help="View certificates")
    train_cert_parser.add_argument("agent", help="Agent ID")
    train_cert_parser.add_argument("--module", help="Specific module ID")

    # Vault commands (Phase 6)
    vault_parser = subparsers.add_parser("vault", help="HashiCorp Vault operations")
    vault_subparsers = vault_parser.add_subparsers(dest="vault_command")

    vault_get_parser = vault_subparsers.add_parser("get", help="Get secret from Vault")
    vault_get_parser.add_argument("path", help="Secret path")
    vault_get_parser.add_argument("--version", type=int, help="Secret version")
    vault_get_parser.add_argument("--mock", action="store_true", help="Use mock Vault client")

    vault_set_parser = vault_subparsers.add_parser("set", help="Set secret in Vault")
    vault_set_parser.add_argument("path", help="Secret path")
    vault_set_parser.add_argument("data", help="Secret data (JSON)")
    vault_set_parser.add_argument("--mock", action="store_true", help="Use mock Vault client")

    vault_list_parser = vault_subparsers.add_parser("list", help="List secrets in Vault")
    vault_list_parser.add_argument("path", nargs="?", default="", help="Secret path prefix")
    vault_list_parser.add_argument("--mock", action="store_true", help="Use mock Vault client")

    vault_delete_parser = vault_subparsers.add_parser("delete", help="Delete secret from Vault")
    vault_delete_parser.add_argument("path", help="Secret path")
    vault_delete_parser.add_argument("--mock", action="store_true", help="Use mock Vault client")

    vault_rotate_parser = vault_subparsers.add_parser("rotate", help="Rotate a secret")
    vault_rotate_parser.add_argument("policy_id", help="Rotation policy ID")
    vault_rotate_parser.add_argument("--force", action="store_true", help="Force rotation")
    vault_rotate_parser.add_argument("--mock", action="store_true", help="Use mock Vault client")

    vault_scan_parser = vault_subparsers.add_parser("scan", help="Scan for hardcoded secrets")
    vault_scan_parser.add_argument("target", help="File or directory to scan")
    vault_scan_parser.add_argument("--output", help="Save report to file (JSON)")

    vault_health_parser = vault_subparsers.add_parser("health", help="Check Vault health")
    vault_health_parser.add_argument("--mock", action="store_true", help="Use mock Vault client")

    vault_policies_parser = vault_subparsers.add_parser("policies", help="Manage rotation policies")
    vault_policies_subparsers = vault_policies_parser.add_subparsers(dest="vault_policies_command")

    vault_policies_list_parser = vault_policies_subparsers.add_parser("list", help="List rotation policies")
    vault_policies_list_parser.add_argument("--mock", action="store_true", help="Use mock Vault client")

    vault_policies_check_parser = vault_policies_subparsers.add_parser("check", help="Check for due rotations")
    vault_policies_check_parser.add_argument("--mock", action="store_true", help="Use mock Vault client")

    # Status command
    subparsers.add_parser("status", help="Show Akali status")

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        return

    cli = AkaliCLI()

    try:
        if args.command == "scan":
            # Determine which scanners to run
            scanner_types = []
            if args.secrets_only:
                scanner_types = ["secrets"]
            elif args.deps_only:
                scanner_types = ["dependencies"]
            elif args.sast_only:
                scanner_types = ["sast"]

            print(f"ü•∑ Akali: Scanning {args.target}...\n")
            findings = cli.scan(args.target, scanner_types if scanner_types else None)

            if findings:
                print(f"\n‚ö†Ô∏è  Found {len(findings)} security issues")
                print(f"   Run 'akali findings list' to see details")
                sys.exit(1)
            else:
                print(f"\n‚úÖ No security issues found")
                sys.exit(0)

        elif args.command == "findings":
            if args.findings_command == "list":
                status = None
                if args.open:
                    status = "open"
                elif args.closed:
                    status = "closed"

                severity = None
                if args.critical:
                    severity = "critical"
                elif args.high:
                    severity = "high"

                cli.list_findings(status=status, severity=severity, scanner=args.scanner)

            elif args.findings_command == "show":
                cli.show_finding(args.finding_id)

            else:
                findings_parser.print_help()

        elif args.command == "attack":
            # Determine attack type
            if args.web:
                attack_type = "web"
            elif args.network:
                attack_type = "network"
            elif args.api:
                attack_type = "api"
            elif args.full:
                attack_type = "full"
            else:
                # Default to full if no specific type
                attack_type = "full"

            print(f"ü•∑ Akali: Offensive scan on {args.target}\n")

            # Pass additional kwargs
            kwargs = {}
            if args.ports:
                kwargs["ports"] = args.ports
            if args.wordlist:
                kwargs["wordlist"] = args.wordlist

            findings = cli.attack(args.target, attack_type=attack_type, quick=args.quick, **kwargs)

            if findings:
                print(f"\n‚ö†Ô∏è  Found {len(findings)} security issues")
                print(f"   Run 'akali findings list' to see details")
                sys.exit(1)
            else:
                print(f"\n‚úÖ No critical vulnerabilities found")
                sys.exit(0)

        elif args.command == "exploit":
            cli.exploit(args.cve_id)

        elif args.command == "schedule":
            if args.schedule_command == "list":
                cli.schedule_list()
            elif args.schedule_command == "run":
                cli.schedule_run(args.job_id)
            else:
                schedule_parser.print_help()

        elif args.command == "daemon":
            if args.daemon_command == "start":
                cli.daemon_start(args.type)
            elif args.daemon_command == "stop":
                cli.daemon_stop(args.type)
            elif args.daemon_command == "status":
                cli.daemon_status()
            else:
                daemon_parser.print_help()

        elif args.command == "alert":
            if args.alert_command == "send":
                cli.alert_send(args.finding_id, agent_id=args.agent if hasattr(args, 'agent') else None)
            elif args.alert_command == "list":
                cli.alert_list(pending=args.pending)
            elif args.alert_command == "ack":
                cli.alert_ack(args.alert_id)
            else:
                alert_parser.print_help()

        elif args.command == "triage":
            cli.triage_finding(args.finding_id)

        elif args.command == "intel":
            if args.intel_command == "cve-check":
                cli.intel_cve_check(hours=args.hours)
            elif args.intel_command == "cve-lookup":
                cli.intel_cve_lookup(args.cve_id)
            elif args.intel_command == "scan-deps":
                cli.intel_scan_deps()
            elif args.intel_command == "impact":
                cli.intel_impact(args.cve_id)
            elif args.intel_command == "threat-feed":
                cli.intel_threat_feed()
            elif args.intel_command == "breach-check":
                cli.intel_breach_check(args.email)
            else:
                intel_parser.print_help()

        elif args.command == "metrics":
            if args.metrics_command == "score" or not args.metrics_command:
                cli.metrics_score()
            elif args.metrics_command == "history":
                cli.metrics_history(days=args.days)
            elif args.metrics_command == "observatory":
                cli.metrics_observatory()
            else:
                metrics_parser.print_help()

        elif args.command == "dashboard":
            if args.dashboard_command == "start":
                cli.dashboard_start(host=args.host, port=args.port)
            elif args.dashboard_command == "status":
                cli.dashboard_status()
            else:
                dashboard_parser.print_help()

        elif args.command == "incident":
            if args.incident_command == "create":
                cli.incident_create(
                    title=args.title,
                    severity=args.severity,
                    description=args.description,
                    incident_type=args.type,
                    systems=args.systems
                )
            elif args.incident_command == "list":
                cli.incident_list(status=args.status, severity=args.severity)
            elif args.incident_command == "show":
                cli.incident_show(args.incident_id)
            elif args.incident_command == "update":
                cli.incident_update(args.incident_id, args.status)
            elif args.incident_command == "close":
                cli.incident_close(args.incident_id, args.resolution)
            else:
                incident_parser.print_help()

        elif args.command == "war-room":
            if args.warroom_command == "start":
                cli.war_room_start(args.incident_id)
            elif args.warroom_command == "stop":
                cli.war_room_stop(resolution=args.resolution)
            elif args.warroom_command == "status":
                cli.war_room_status()
            else:
                warroom_parser.print_help()

        elif args.command == "playbook":
            if args.playbook_command == "list":
                cli.playbook_list()
            elif args.playbook_command == "run":
                cli.playbook_run(args.playbook_id, args.incident_id)
            elif args.playbook_command == "status":
                cli.playbook_status(args.run_id)
            else:
                playbook_parser.print_help()

        elif args.command == "post-mortem":
            cli.post_mortem(args.incident_id, output=args.output)

        elif args.command == "train":
            if args.train_command == "list":
                cli.train_list()
            elif args.train_command == "start":
                cli.train_start(args.module_id, agent_id=args.agent)
            elif args.train_command == "progress":
                cli.train_progress(agent_id=args.agent)
            elif args.train_command == "certificate":
                cli.train_certificate(args.agent, module_id=args.module)
            else:
                train_parser.print_help()

        elif args.command == "vault":
            if args.vault_command == "get":
                cli.vault_get(args.path, version=args.version, mock=args.mock)

            elif args.vault_command == "set":
                cli.vault_set(args.path, args.data, mock=args.mock)

            elif args.vault_command == "list":
                cli.vault_list(args.path, mock=args.mock)

            elif args.vault_command == "delete":
                cli.vault_delete(args.path, mock=args.mock)

            elif args.vault_command == "rotate":
                cli.vault_rotate(args.policy_id, force=args.force, mock=args.mock)

            elif args.vault_command == "scan":
                cli.vault_scan(args.target, output=args.output)

            elif args.vault_command == "health":
                cli.vault_health(mock=args.mock)

            elif args.vault_command == "policies":
                if args.vault_policies_command == "list":
                    cli.vault_policies_list(mock=args.mock)
                elif args.vault_policies_command == "check":
                    cli.vault_policies_check(mock=args.mock)
                else:
                    vault_policies_parser.print_help()

            else:
                vault_parser.print_help()

        elif args.command == "status":
            cli.status()

    except KeyboardInterrupt:
        print("\n\nüëã Interrupted by user")
        sys.exit(130)
    except Exception as e:
        print(f"\n‚ùå Error: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
