"""Tests for binary fuzzer module."""

import pytest
import tempfile
import os
from pathlib import Path
from exploits.fuzzer.binary_fuzzer import BinaryFuzzer


class TestBinaryFuzzer:
    """Test suite for BinaryFuzzer class."""

    @pytest.fixture
    def binary_fuzzer(self):
        """Create a binary fuzzer instance."""
        return BinaryFuzzer()

    @pytest.fixture
    def temp_dir(self):
        """Create a temporary directory."""
        with tempfile.TemporaryDirectory() as tmpdir:
            yield tmpdir

    @pytest.fixture
    def simple_binary(self, temp_dir):
        """Create a simple test binary."""
        binary_path = Path(temp_dir) / "test.c"
        binary_path.write_text("""
#include <stdio.h>
int main(int argc, char *argv[]) {
    if (argc > 1) {
        printf("Input: %s\\n", argv[1]);
    }
    return 0;
}
""")
        return str(binary_path)

    def test_binary_fuzzer_initialization(self, binary_fuzzer):
        """Test binary fuzzer initializes correctly."""
        assert binary_fuzzer is not None
        assert hasattr(binary_fuzzer, 'check_afl_available')
        assert hasattr(binary_fuzzer, 'fuzz_with_afl')
        assert hasattr(binary_fuzzer, 'fuzz_with_python')

    def test_check_afl_availability(self, binary_fuzzer):
        """Test AFL++ availability check."""
        result = binary_fuzzer.check_afl_available()
        assert isinstance(result, bool)

    def test_fuzz_with_python_basic(self, binary_fuzzer, simple_binary, temp_dir):
        """Test Python-based fuzzing."""
        corpus_dir = Path(temp_dir) / "corpus"
        corpus_dir.mkdir()
        (corpus_dir / "seed1.txt").write_text("test")

        # Compile binary
        import subprocess
        binary_path = Path(temp_dir) / "test"
        try:
            subprocess.run(
                ["gcc", simple_binary, "-o", str(binary_path)],
                check=True,
                capture_output=True,
                timeout=10
            )
        except (subprocess.CalledProcessError, FileNotFoundError):
            pytest.skip("GCC not available")

        result = binary_fuzzer.fuzz_with_python(
            str(binary_path),
            str(corpus_dir),
            timeout=2
        )

        assert isinstance(result, dict)
        assert 'iterations' in result
        assert 'crashes' in result
        assert 'method' in result
        assert result['method'] == 'python'

    def test_detect_crash_segfault(self, binary_fuzzer):
        """Test crash detection for segfault."""
        # Exit code 139 typically indicates SIGSEGV
        crash_info = binary_fuzzer.detect_crash(139, b"", b"Segmentation fault")

        assert crash_info is not None
        assert crash_info['type'] == 'crash'
        assert 'signal' in crash_info

    def test_detect_crash_normal_exit(self, binary_fuzzer):
        """Test that normal exit is not detected as crash."""
        crash_info = binary_fuzzer.detect_crash(0, b"Normal output", b"")

        assert crash_info is None

    def test_mutation_strategies(self, binary_fuzzer):
        """Test different mutation strategies."""
        seed = b"AAAA"

        # Test bit flip
        mutated = binary_fuzzer.mutate_bit_flip(seed)
        assert len(mutated) == len(seed)
        assert mutated != seed

        # Test byte flip
        mutated = binary_fuzzer.mutate_byte_flip(seed)
        assert len(mutated) == len(seed)

        # Test byte insertion
        mutated = binary_fuzzer.mutate_byte_insert(seed)
        assert len(mutated) > len(seed)

        # Test byte deletion
        mutated = binary_fuzzer.mutate_byte_delete(seed)
        assert len(mutated) < len(seed) or len(seed) <= 1

    def test_interesting_value_mutations(self, binary_fuzzer):
        """Test mutations with interesting values."""
        seed = b"\x00\x00\x00\x00"
        mutated = binary_fuzzer.mutate_interesting_values(seed)

        assert isinstance(mutated, bytes)
        # Should replace with interesting values like -1, 0xff, etc.

    def test_chunk_mutation(self, binary_fuzzer):
        """Test chunk-based mutations."""
        seed = b"AAAA" + b"BBBB" + b"CCCC"
        mutated = binary_fuzzer.mutate_chunk(seed)

        assert isinstance(mutated, bytes)
        # Length can vary due to chunk operations

    def test_fuzz_iteration_tracking(self, binary_fuzzer, simple_binary, temp_dir):
        """Test that fuzzer tracks iterations correctly."""
        corpus_dir = Path(temp_dir) / "corpus"
        corpus_dir.mkdir()
        (corpus_dir / "seed1.txt").write_text("test")

        import subprocess
        binary_path = Path(temp_dir) / "test"
        try:
            subprocess.run(
                ["gcc", simple_binary, "-o", str(binary_path)],
                check=True,
                capture_output=True,
                timeout=10
            )
        except (subprocess.CalledProcessError, FileNotFoundError):
            pytest.skip("GCC not available")

        result = binary_fuzzer.fuzz_with_python(
            str(binary_path),
            str(corpus_dir),
            timeout=1
        )

        assert result['iterations'] > 0

    def test_crash_output_saved(self, binary_fuzzer, temp_dir):
        """Test that crash inputs are saved."""
        crash_dir = Path(temp_dir) / "crashes"
        crash_dir.mkdir()

        crash_input = b"CRASH_DATA"
        binary_fuzzer.save_crash(crash_input, str(crash_dir), "test_crash")

        crash_files = list(crash_dir.glob("*"))
        assert len(crash_files) > 0

        # Verify content
        saved_content = crash_files[0].read_bytes()
        assert crash_input in saved_content or saved_content == crash_input

    def test_afl_command_construction(self, binary_fuzzer, temp_dir):
        """Test AFL++ command construction."""
        if not binary_fuzzer.check_afl_available():
            pytest.skip("AFL++ not available")

        cmd = binary_fuzzer.build_afl_command(
            binary_path="/path/to/binary",
            corpus_dir=str(temp_dir),
            output_dir=str(temp_dir),
            timeout=3600
        )

        assert isinstance(cmd, list)
        assert 'afl-fuzz' in cmd[0]
        assert '-i' in cmd
        assert '-o' in cmd

    def test_empty_corpus_handling(self, binary_fuzzer, simple_binary, temp_dir):
        """Test handling of empty corpus directory."""
        corpus_dir = Path(temp_dir) / "corpus"
        corpus_dir.mkdir()
        # Empty corpus

        import subprocess
        binary_path = Path(temp_dir) / "test"
        try:
            subprocess.run(
                ["gcc", simple_binary, "-o", str(binary_path)],
                check=True,
                capture_output=True,
                timeout=10
            )
        except (subprocess.CalledProcessError, FileNotFoundError):
            pytest.skip("GCC not available")

        # Should create default seeds or handle gracefully
        result = binary_fuzzer.fuzz_with_python(
            str(binary_path),
            str(corpus_dir),
            timeout=1
        )

        assert isinstance(result, dict)
