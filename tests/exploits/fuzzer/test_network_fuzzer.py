"""Tests for network fuzzer module."""

import pytest
import socket
import threading
import time
from exploits.fuzzer.network_fuzzer import NetworkFuzzer


class TestNetworkFuzzer:
    """Test suite for NetworkFuzzer class."""

    @pytest.fixture
    def network_fuzzer(self):
        """Create a network fuzzer instance."""
        return NetworkFuzzer()

    @pytest.fixture
    def mock_tcp_server(self):
        """Create a mock TCP server for testing."""
        server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        server_socket.bind(('127.0.0.1', 0))
        server_socket.listen(1)
        port = server_socket.getsockname()[1]

        def handle_connections():
            while True:
                try:
                    server_socket.settimeout(1.0)
                    client, addr = server_socket.accept()
                    client.settimeout(1.0)
                    data = client.recv(1024)
                    client.send(b"OK\n")
                    client.close()
                except socket.timeout:
                    continue
                except OSError:
                    break

        server_thread = threading.Thread(target=handle_connections, daemon=True)
        server_thread.start()

        yield port

        server_socket.close()

    def test_network_fuzzer_initialization(self, network_fuzzer):
        """Test network fuzzer initializes correctly."""
        assert network_fuzzer is not None
        assert hasattr(network_fuzzer, 'fuzz_tcp')
        assert hasattr(network_fuzzer, 'fuzz_udp')
        assert hasattr(network_fuzzer, 'fuzz_http')

    def test_fuzz_tcp_basic(self, network_fuzzer, mock_tcp_server):
        """Test basic TCP fuzzing."""
        result = network_fuzzer.fuzz_tcp(
            target='127.0.0.1',
            port=mock_tcp_server,
            iterations=10,
            timeout_per_request=0.5
        )

        assert isinstance(result, dict)
        assert 'iterations' in result
        assert 'responses' in result
        assert 'anomalies' in result
        assert result['iterations'] == 10

    def test_fuzz_tcp_with_seeds(self, network_fuzzer, mock_tcp_server):
        """Test TCP fuzzing with seed inputs."""
        seeds = [
            b"GET / HTTP/1.1\r\n\r\n",
            b"POST /api HTTP/1.1\r\n\r\n",
            b"\x00\x01\x02\x03"
        ]

        result = network_fuzzer.fuzz_tcp(
            target='127.0.0.1',
            port=mock_tcp_server,
            iterations=15,
            seeds=seeds,
            timeout_per_request=0.5
        )

        assert result['iterations'] == 15
        assert 'seed_based' in result

    def test_fuzz_udp_basic(self, network_fuzzer):
        """Test basic UDP fuzzing."""
        # UDP doesn't require a listening server
        result = network_fuzzer.fuzz_udp(
            target='127.0.0.1',
            port=9999,
            iterations=10,
            timeout_per_request=0.1
        )

        assert isinstance(result, dict)
        assert 'iterations' in result
        assert result['iterations'] == 10

    def test_fuzz_http_basic(self, network_fuzzer):
        """Test basic HTTP fuzzing."""
        # Test against non-existent server to verify request generation
        result = network_fuzzer.fuzz_http(
            target='http://127.0.0.1:9999',
            iterations=5,
            timeout_per_request=0.5
        )

        assert isinstance(result, dict)
        assert 'iterations' in result
        assert 'requests' in result

    def test_detect_anomaly_timeout(self, network_fuzzer):
        """Test anomaly detection for timeouts."""
        anomaly = network_fuzzer.detect_anomaly(
            response_time=5.0,
            status='timeout',
            response_data=b''
        )

        assert anomaly is not None
        assert anomaly['type'] == 'timeout'

    def test_detect_anomaly_long_response(self, network_fuzzer):
        """Test anomaly detection for unusually long responses."""
        long_response = b"A" * 100000

        anomaly = network_fuzzer.detect_anomaly(
            response_time=0.1,
            status='success',
            response_data=long_response
        )

        assert anomaly is not None
        assert anomaly['type'] == 'large_response'

    def test_detect_anomaly_connection_refused(self, network_fuzzer):
        """Test anomaly detection for connection errors."""
        anomaly = network_fuzzer.detect_anomaly(
            response_time=0.0,
            status='connection_refused',
            response_data=b''
        )

        assert anomaly is not None
        assert anomaly['type'] == 'connection_error'

    def test_generate_tcp_payloads(self, network_fuzzer):
        """Test TCP payload generation."""
        payloads = network_fuzzer.generate_tcp_payloads(count=10)

        assert len(payloads) == 10
        assert all(isinstance(p, bytes) for p in payloads)
        # Should have variety
        assert len(set(payloads)) > 1

    def test_generate_http_requests(self, network_fuzzer):
        """Test HTTP request generation."""
        requests = network_fuzzer.generate_http_requests(count=10)

        assert len(requests) == 10
        # Should contain valid HTTP methods
        assert any(b'GET' in r or b'POST' in r for r in requests)

    def test_mutate_payload(self, network_fuzzer):
        """Test payload mutation."""
        seed = b"GET / HTTP/1.1\r\n"
        mutated = network_fuzzer.mutate_payload(seed)

        assert isinstance(mutated, bytes)
        assert mutated != seed or len(mutated) != len(seed)

    def test_protocol_specific_mutations_http(self, network_fuzzer):
        """Test HTTP-specific mutations."""
        seed = b"GET /test HTTP/1.1\r\nHost: example.com\r\n\r\n"
        mutated = network_fuzzer.mutate_http_payload(seed)

        assert isinstance(mutated, bytes)
        # Should still have some HTTP structure
        assert b'HTTP' in mutated or b'GET' in mutated or b'POST' in mutated

    def test_response_tracking(self, network_fuzzer, mock_tcp_server):
        """Test that fuzzer tracks unique responses."""
        result = network_fuzzer.fuzz_tcp(
            target='127.0.0.1',
            port=mock_tcp_server,
            iterations=20,
            timeout_per_request=0.5
        )

        assert 'unique_responses' in result
        assert isinstance(result['unique_responses'], int)

    def test_timeout_handling(self, network_fuzzer):
        """Test that fuzzer handles timeouts correctly."""
        # Try to connect to a non-routable IP
        result = network_fuzzer.fuzz_tcp(
            target='192.0.2.1',  # TEST-NET-1, should timeout
            port=9999,
            iterations=3,
            timeout_per_request=0.5
        )

        assert 'errors' in result
        assert result['errors'] > 0

    def test_concurrent_connections(self, network_fuzzer, mock_tcp_server):
        """Test fuzzing with concurrent connections."""
        result = network_fuzzer.fuzz_tcp(
            target='127.0.0.1',
            port=mock_tcp_server,
            iterations=20,
            concurrent=True,
            max_workers=3,
            timeout_per_request=0.5
        )

        assert result['iterations'] == 20

    def test_fuzz_with_corpus(self, network_fuzzer, mock_tcp_server):
        """Test fuzzing using a corpus of seeds."""
        import tempfile
        from pathlib import Path

        with tempfile.TemporaryDirectory() as tmpdir:
            corpus_dir = Path(tmpdir)
            (corpus_dir / "seed1.txt").write_bytes(b"TEST1")
            (corpus_dir / "seed2.txt").write_bytes(b"TEST2")

            result = network_fuzzer.fuzz_tcp(
                target='127.0.0.1',
                port=mock_tcp_server,
                iterations=10,
                corpus_dir=str(corpus_dir),
                timeout_per_request=0.5
            )

            assert 'corpus_seeds' in result
            assert result['corpus_seeds'] == 2

    def test_error_recovery(self, network_fuzzer):
        """Test that fuzzer recovers from errors and continues."""
        # Fuzz invalid target
        result = network_fuzzer.fuzz_tcp(
            target='invalid.invalid.invalid',
            port=9999,
            iterations=5,
            timeout_per_request=0.1
        )

        # Should complete all iterations despite errors
        assert result['iterations'] == 5
        assert result['errors'] > 0
