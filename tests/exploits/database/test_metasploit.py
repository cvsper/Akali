"""Tests for Metasploit integration."""

import pytest
from unittest.mock import Mock, patch
from exploits.database.metasploit import MetasploitSearch


class TestMetasploitSearch:
    """Test suite for Metasploit search."""

    def test_check_available(self):
        """Test checking if Metasploit is available"""
        searcher = MetasploitSearch()

        with patch('subprocess.run') as mock_run:
            mock_run.return_value = Mock(returncode=0)

            assert searcher.check_available() is True

    def test_check_not_available(self):
        """Test handling when Metasploit is not installed"""
        searcher = MetasploitSearch()

        with patch('subprocess.run', side_effect=FileNotFoundError):
            assert searcher.check_available() is False

    def test_search_modules(self):
        """Test searching Metasploit modules"""
        searcher = MetasploitSearch()

        mock_output = """
Matching Modules
================

   #  Name                                          Disclosure Date  Rank    Check  Description
   -  ----                                          ---------------  ----    -----  -----------
   0  exploit/windows/smb/ms17_010_eternalblue      2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   1  auxiliary/scanner/smb/smb_ms17_010                             normal   No     MS17-010 SMB RCE Detection
"""

        with patch('subprocess.run') as mock_run:
            mock_run.return_value = Mock(returncode=0, stdout=mock_output)

            results = searcher.search("ms17-010")

            assert len(results) == 2
            assert results[0]['name'] == "exploit/windows/smb/ms17_010_eternalblue"
            assert results[0]['type'] == 'exploit'
            assert results[1]['type'] == 'auxiliary'

    def test_get_module_info(self):
        """Test getting detailed module information"""
        searcher = MetasploitSearch()

        mock_output = """
       Name: MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
     Module: exploit/windows/smb/ms17_010_eternalblue
   Platform: Windows
       Arch: x64, x86
 Privileged: Yes
    License: Metasploit Framework License (BSD)
       Rank: Average
  Disclosed: 2017-03-14

Description:
  This module is a port of the Equation Group ETERNALBLUE exploit

References:
  https://nvd.nist.gov/vuln/detail/CVE-2017-0144
"""

        with patch('subprocess.run') as mock_run:
            mock_run.return_value = Mock(returncode=0, stdout=mock_output)

            info = searcher.get_module_info("exploit/windows/smb/ms17_010_eternalblue")

            assert info is not None
            assert 'name' in info
            assert 'platform' in info
            assert 'rank' in info

    def test_parse_module_list(self):
        """Test parsing module list output"""
        searcher = MetasploitSearch()

        output = """
   0  exploit/windows/smb/ms17_010_eternalblue      2017-03-14       average  Yes    MS17-010 EternalBlue
   1  auxiliary/scanner/smb/smb_ms17_010                             normal   No     MS17-010 Scanner
"""

        results = searcher._parse_module_list(output)

        assert len(results) == 2
        assert results[0]['name'] == "exploit/windows/smb/ms17_010_eternalblue"
        assert results[0]['rank'] == 'average'
        assert results[1]['name'] == "auxiliary/scanner/smb/smb_ms17_010"

    def test_get_exploit_options(self):
        """Test getting module options"""
        searcher = MetasploitSearch()

        mock_output = """
Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOSTS                          yes       The target host(s)
   RPORT          445              yes       The target port
   SMBDomain      .                no        The Windows domain
"""

        with patch('subprocess.run') as mock_run:
            mock_run.return_value = Mock(returncode=0, stdout=mock_output)

            options = searcher.get_module_options("exploit/windows/smb/ms17_010_eternalblue")

            assert len(options) >= 2
            assert any(opt['name'] == 'RHOSTS' for opt in options)
            assert any(opt['name'] == 'RPORT' for opt in options)
