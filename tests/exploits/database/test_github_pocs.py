"""Tests for GitHub POC search."""

import pytest
from unittest.mock import Mock, patch
from exploits.database.github_pocs import GitHubPOCSearch


class TestGitHubPOCSearch:
    """Test suite for GitHub POC search."""

    def test_search_repositories(self):
        """Test searching GitHub repositories"""
        searcher = GitHubPOCSearch()

        mock_response = {
            "items": [
                {
                    "full_name": "user/cve-2021-1234",
                    "description": "POC for CVE-2021-1234",
                    "html_url": "https://github.com/user/cve-2021-1234",
                    "stargazers_count": 100,
                    "created_at": "2021-01-01T00:00:00Z",
                    "updated_at": "2021-06-01T00:00:00Z"
                }
            ]
        }

        with patch('requests.get') as mock_get:
            mock_get.return_value = Mock(status_code=200, json=lambda: mock_response)

            results = searcher.search("CVE-2021-1234")

            assert len(results) > 0
            assert results[0]['source'] == 'github'
            assert results[0]['stars'] == 100

    def test_search_code(self):
        """Test searching GitHub code"""
        searcher = GitHubPOCSearch()

        mock_response = {
            "items": [
                {
                    "repository": {
                        "full_name": "user/exploit-db",
                        "html_url": "https://github.com/user/exploit-db"
                    },
                    "path": "exploits/cve-2021-1234.py",
                    "html_url": "https://github.com/user/exploit-db/blob/main/exploits/cve-2021-1234.py"
                }
            ]
        }

        with patch('requests.get') as mock_get:
            mock_get.return_value = Mock(status_code=200, json=lambda: mock_response)

            results = searcher.search_code("CVE-2021-1234 exploit")

            assert len(results) > 0
            assert 'repository' in results[0]

    def test_rate_limit_handling(self):
        """Test handling GitHub API rate limits"""
        searcher = GitHubPOCSearch()

        with patch('requests.get') as mock_get:
            mock_get.return_value = Mock(status_code=403)

            results = searcher.search("test")

            assert isinstance(results, list)
            assert len(results) == 0

    def test_download_poc(self):
        """Test downloading POC file from GitHub"""
        searcher = GitHubPOCSearch()

        mock_content = b"#!/bin/bash\necho 'POC'"

        with patch('requests.get') as mock_get:
            mock_get.return_value = Mock(status_code=200, content=mock_content)

            with patch('pathlib.Path.write_bytes') as mock_write:
                success = searcher.download(
                    "https://github.com/user/repo/blob/main/poc.sh",
                    "/tmp/poc.sh"
                )

                assert success is True

    def test_convert_blob_to_raw_url(self):
        """Test converting GitHub blob URL to raw URL"""
        searcher = GitHubPOCSearch()

        blob_url = "https://github.com/user/repo/blob/main/exploit.py"
        raw_url = searcher._convert_to_raw_url(blob_url)

        assert "raw.githubusercontent.com" in raw_url
        assert "/blob/" not in raw_url

    def test_filter_by_stars(self):
        """Test filtering results by minimum stars"""
        searcher = GitHubPOCSearch()

        results = [
            {"stars": 500, "title": "Popular POC"},
            {"stars": 10, "title": "Unpopular POC"},
            {"stars": 100, "title": "Medium POC"}
        ]

        filtered = searcher.filter_by_stars(results, min_stars=50)

        assert len(filtered) == 2
        assert all(r['stars'] >= 50 for r in filtered)
