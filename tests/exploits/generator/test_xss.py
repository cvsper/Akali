"""Tests for XSS Generator."""

import pytest
from exploits.generator.xss import XSSGenerator


class TestXSSGenerator:
    """Test suite for XSSGenerator."""

    def setup_method(self):
        """Setup test fixtures."""
        self.generator = XSSGenerator()

    # Basic XSS Tests

    def test_generate_script_context_basic(self):
        """Test basic script context XSS."""
        payloads = self.generator.generate_script_context()

        assert isinstance(payloads, list)
        assert len(payloads) > 0
        assert any("<script>" in p.lower() for p in payloads)

    def test_generate_html_context_basic(self):
        """Test basic HTML context XSS."""
        payloads = self.generator.generate_html_context()

        assert isinstance(payloads, list)
        assert any("<" in p and ">" in p for p in payloads)

    def test_generate_attribute_context(self):
        """Test attribute context XSS."""
        payloads = self.generator.generate_attribute_context()

        assert isinstance(payloads, list)
        # Should include quote breakout attempts
        assert any('"' in p or "'" in p for p in payloads)

    # Event Handler Tests

    def test_generate_event_handler_payloads(self):
        """Test event handler-based XSS."""
        payloads = self.generator.generate_event_handlers()

        assert isinstance(payloads, list)
        assert any("onerror" in p.lower() or "onload" in p.lower() for p in payloads)

    def test_generate_img_tag_payloads(self):
        """Test IMG tag-based XSS."""
        payloads = self.generator.generate_img_payloads()

        assert isinstance(payloads, list)
        assert any("<img" in p.lower() for p in payloads)
        assert any("onerror" in p.lower() or "onload" in p.lower() for p in payloads)

    # DOM XSS Tests

    def test_generate_dom_based(self):
        """Test DOM-based XSS payloads."""
        payloads = self.generator.generate_dom_based()

        assert isinstance(payloads, list)
        assert any("document." in p.lower() or "window." in p.lower() for p in payloads)

    def test_generate_dom_sink_payloads(self):
        """Test payloads for different DOM sinks."""
        sinks = ["innerHTML", "document.write", "eval"]

        for sink in sinks:
            payloads = self.generator.generate_for_dom_sink(sink)
            assert isinstance(payloads, list)
            assert len(payloads) > 0

    # Reflected XSS Tests

    def test_generate_reflected_xss(self):
        """Test reflected XSS payloads."""
        payloads = self.generator.generate_reflected()

        assert isinstance(payloads, list)
        assert len(payloads) > 0

    # Stored XSS Tests

    def test_generate_stored_xss(self):
        """Test stored XSS payloads."""
        payloads = self.generator.generate_stored()

        assert isinstance(payloads, list)
        assert len(payloads) > 0
        # Stored XSS often uses less obvious vectors
        assert any(p for p in payloads)

    # Filter Evasion Tests

    def test_generate_with_filter_evasion(self):
        """Test XSS with filter evasion."""
        payloads = self.generator.generate_script_context(filter_evasion=True)

        assert isinstance(payloads, list)
        # Should include various evasion techniques
        assert any(p for p in payloads)

    def test_generate_case_variation_evasion(self):
        """Test case variation evasion."""
        payloads = self.generator.generate_case_variants("<script>alert(1)</script>")

        assert isinstance(payloads, list)
        assert len(payloads) > 1
        assert all("script" in p.lower() for p in payloads)

    def test_generate_encoding_evasion(self):
        """Test encoding-based evasion."""
        payload = "<script>alert(1)</script>"
        encoded_variants = self.generator.generate_encoded_variants(payload)

        assert isinstance(encoded_variants, list)
        assert len(encoded_variants) > 0

    def test_generate_obfuscation_evasion(self):
        """Test JavaScript obfuscation."""
        payload = "alert(1)"
        obfuscated = self.generator.obfuscate_javascript(payload)

        assert isinstance(obfuscated, list)
        # Should still contain some recognizable parts or be valid JS
        assert len(obfuscated) > 0

    # Context-Specific Tests

    def test_generate_url_context(self):
        """Test XSS for URL context."""
        payloads = self.generator.generate_url_context()

        assert isinstance(payloads, list)
        assert any("javascript:" in p.lower() or "data:" in p.lower() for p in payloads)

    def test_generate_css_context(self):
        """Test XSS for CSS context."""
        payloads = self.generator.generate_css_context()

        assert isinstance(payloads, list)
        assert any("expression" in p.lower() or "import" in p.lower() for p in payloads)

    def test_generate_json_context(self):
        """Test XSS for JSON context."""
        payloads = self.generator.generate_json_context()

        assert isinstance(payloads, list)
        assert any('"' in p or "{" in p for p in payloads)

    # Encoding Tests

    def test_encode_html_entities(self):
        """Test HTML entity encoding."""
        payload = "<script>"
        encoded = self.generator.encode_html_entities(payload)

        assert "&lt;" in encoded or "&#" in encoded
        assert "<" not in encoded

    def test_encode_unicode(self):
        """Test Unicode encoding."""
        payload = "<script>"
        encoded = self.generator.encode_unicode(payload)

        assert "\\u" in encoded or r"\u" in encoded

    def test_encode_hex(self):
        """Test hex encoding."""
        payload = "alert"
        encoded = self.generator.encode_hex(payload)

        assert all(c in "0123456789abcdefABCDEFx\\" for c in encoded.replace("\\x", ""))

    def test_encode_decimal(self):
        """Test decimal encoding."""
        payload = "<"
        encoded = self.generator.encode_decimal(payload)

        assert "&#" in encoded
        assert "60" in encoded  # ASCII code for '<'

    # Polyglot Tests

    def test_generate_polyglot_payloads(self):
        """Test polyglot XSS payloads that work in multiple contexts."""
        payloads = self.generator.generate_polyglots()

        assert isinstance(payloads, list)
        assert len(payloads) > 0
        # Polyglots should work in multiple contexts
        assert any(p for p in payloads)

    # WAF Bypass Tests

    def test_generate_waf_bypass(self):
        """Test WAF bypass techniques."""
        payloads = self.generator.generate_waf_bypass()

        assert isinstance(payloads, list)
        assert len(payloads) > 0

    def test_generate_null_byte_injection(self):
        """Test null byte injection for filter bypass."""
        payload = "<script>alert(1)</script>"
        variants = self.generator.inject_null_bytes(payload)

        assert isinstance(variants, list)
        # May or may not support null bytes depending on implementation
        assert len(variants) >= 1

    # Mutation Tests

    def test_generate_mutation_based(self):
        """Test mutation-based XSS (mXSS)."""
        payloads = self.generator.generate_mutation_xss()

        assert isinstance(payloads, list)
        assert len(payloads) > 0

    # Template Injection Tests

    def test_generate_template_injection(self):
        """Test template injection payloads (SSTI leading to XSS)."""
        payloads = self.generator.generate_template_injection()

        assert isinstance(payloads, list)
        assert any("{{" in p or "{%" in p for p in payloads)

    # Protocol Handler Tests

    def test_generate_protocol_handlers(self):
        """Test various protocol handlers."""
        payloads = self.generator.generate_protocol_handlers()

        assert isinstance(payloads, list)
        assert any("javascript:" in p.lower() or "data:" in p.lower() or "vbscript:" in p.lower() for p in payloads)

    # SVG Tests

    def test_generate_svg_payloads(self):
        """Test SVG-based XSS."""
        payloads = self.generator.generate_svg_payloads()

        assert isinstance(payloads, list)
        assert any("<svg" in p.lower() for p in payloads)

    # Blind XSS Tests

    def test_generate_blind_xss(self):
        """Test blind XSS payloads (callback-based)."""
        callback_url = "https://attacker.com/collect"
        payloads = self.generator.generate_blind_xss(callback_url)

        assert isinstance(payloads, list)
        assert any(callback_url in p for p in payloads)

    # Utility Tests

    def test_detect_context_from_response(self):
        """Test context detection from HTML response."""
        html = '<script>var data = "USER_INPUT";</script>'
        context = self.generator.detect_context(html, "USER_INPUT")

        assert context in ["script", "string", "attribute", "html"]
