"""Tests for SQL Injection Generator."""

import pytest
from exploits.generator.sqli import SQLiGenerator


class TestSQLiGenerator:
    """Test suite for SQLiGenerator."""

    def setup_method(self):
        """Setup test fixtures."""
        self.generator = SQLiGenerator()

    # MySQL Tests

    def test_generate_mysql_union_basic(self):
        """Test basic MySQL UNION injection."""
        payloads = self.generator.generate_mysql_union(columns=3)

        assert isinstance(payloads, list)
        assert len(payloads) > 0
        assert any("UNION" in p and "SELECT" in p for p in payloads)

    def test_generate_mysql_blind_time(self):
        """Test MySQL time-based blind injection."""
        payloads = self.generator.generate_mysql_blind(blind_type="time")

        assert isinstance(payloads, list)
        assert any("SLEEP" in p or "BENCHMARK" in p for p in payloads)

    def test_generate_mysql_blind_boolean(self):
        """Test MySQL boolean-based blind injection."""
        payloads = self.generator.generate_mysql_blind(blind_type="boolean")

        assert isinstance(payloads, list)
        assert any("AND" in p or "OR" in p for p in payloads)

    def test_generate_mysql_error(self):
        """Test MySQL error-based injection."""
        payloads = self.generator.generate_mysql_error()

        assert isinstance(payloads, list)
        assert len(payloads) > 0

    # PostgreSQL Tests

    def test_generate_postgresql_union(self):
        """Test PostgreSQL UNION injection."""
        payloads = self.generator.generate_postgresql_union(columns=3)

        assert isinstance(payloads, list)
        assert any("::" in p or "pg_" in p.lower() for p in payloads)

    def test_generate_postgresql_stacked(self):
        """Test PostgreSQL stacked queries."""
        payloads = self.generator.generate_postgresql_stacked()

        assert isinstance(payloads, list)
        assert any(";" in p for p in payloads)

    # MSSQL Tests

    def test_generate_mssql_union(self):
        """Test MSSQL UNION injection."""
        payloads = self.generator.generate_mssql_union(columns=3)

        assert isinstance(payloads, list)
        assert len(payloads) > 0

    def test_generate_mssql_blind(self):
        """Test MSSQL blind injection."""
        payloads = self.generator.generate_mssql_blind()

        assert isinstance(payloads, list)
        assert any("WAITFOR" in p for p in payloads)

    # Oracle Tests

    def test_generate_oracle_union(self):
        """Test Oracle UNION injection."""
        payloads = self.generator.generate_oracle_union(columns=3)

        assert isinstance(payloads, list)
        assert any("dual" in p.lower() for p in payloads)

    # Generic Tests

    def test_generate_auth_bypass(self):
        """Test authentication bypass payloads."""
        payloads = self.generator.generate_auth_bypass()

        assert isinstance(payloads, list)
        assert any("--" in p or "#" in p or "/*" in p for p in payloads)
        assert any("OR" in p for p in payloads)

    def test_generate_column_enumeration(self):
        """Test column enumeration payloads."""
        payloads = self.generator.generate_column_enumeration(max_columns=10)

        assert isinstance(payloads, list)
        assert any("ORDER BY" in p for p in payloads)

    def test_generate_table_enumeration(self):
        """Test table enumeration payloads."""
        payloads = self.generator.generate_table_enumeration(db_type="mysql")

        assert isinstance(payloads, list)
        assert any("information_schema" in p.lower() for p in payloads)

    # WAF Evasion Tests

    def test_generate_with_waf_evasion(self):
        """Test payloads with WAF evasion techniques."""
        base_payloads = self.generator.generate_mysql_union(columns=3)

        # Apply obfuscation to some payloads
        obfuscated = [self.generator.obfuscate_with_comments(p) for p in base_payloads[:3]]

        assert isinstance(obfuscated, list)
        # Should include various evasion techniques
        assert any("/*" in p for p in obfuscated)

    def test_generate_comment_obfuscation(self):
        """Test comment-based obfuscation."""
        payload = "SELECT * FROM users"
        obfuscated = self.generator.obfuscate_with_comments(payload)

        assert "/*" in obfuscated or "--" in obfuscated
        assert "SELECT" in obfuscated
        assert "users" in obfuscated

    def test_generate_case_variation(self):
        """Test case variation evasion."""
        payload = "UNION SELECT"
        variants = self.generator.generate_case_variants(payload)

        assert isinstance(variants, list)
        assert len(variants) > 1
        assert all("UNION" in v.upper() and "SELECT" in v.upper() for v in variants)

    # Encoding Tests

    def test_encode_payload_url(self):
        """Test URL encoding."""
        payload = "' OR 1=1--"
        encoded = self.generator.encode_payload(payload, "url")

        assert "'" not in encoded
        assert "%" in encoded

    def test_encode_payload_hex(self):
        """Test hex encoding."""
        payload = "UNION"
        encoded = self.generator.encode_payload(payload, "hex")

        assert "0x" in encoded or all(c in "0123456789abcdefABCDEF" for c in encoded.replace("0x", ""))

    # Second-Order Injection Tests

    def test_generate_second_order(self):
        """Test second-order injection payloads."""
        payloads = self.generator.generate_second_order()

        assert isinstance(payloads, list)
        assert len(payloads) > 0

    # JSON Injection Tests

    def test_generate_json_injection(self):
        """Test JSON-based SQL injection."""
        payloads = self.generator.generate_json_injection()

        assert isinstance(payloads, list)
        assert any("{" in p and "}" in p for p in payloads)

    # NoSQL Injection Tests

    def test_generate_nosql_injection(self):
        """Test NoSQL injection payloads."""
        payloads = self.generator.generate_nosql_injection(db_type="mongodb")

        assert isinstance(payloads, list)
        assert any("$" in p for p in payloads)  # MongoDB operators

    # Context-Aware Tests

    def test_generate_for_context_numeric(self):
        """Test payloads for numeric context."""
        payloads = self.generator.generate_for_context(context="numeric")

        assert isinstance(payloads, list)
        assert all("'" not in p for p in payloads)  # No quotes needed

    def test_generate_for_context_string(self):
        """Test payloads for string context."""
        payloads = self.generator.generate_for_context(context="string")

        assert isinstance(payloads, list)
        assert any("'" in p or '"' in p for p in payloads)

    # Utility Tests

    def test_detect_database_type(self):
        """Test database type detection from error messages."""
        mysql_error = "You have an error in your SQL syntax"
        detected = self.generator.detect_db_from_error(mysql_error)

        assert detected == "mysql"

        postgres_error = "ERROR: syntax error at or near"
        detected = self.generator.detect_db_from_error(postgres_error)

        assert detected == "postgresql"
