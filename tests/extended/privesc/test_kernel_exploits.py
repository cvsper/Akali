"""Tests for kernel exploit database module."""

import pytest
from unittest.mock import Mock, patch, MagicMock
from pathlib import Path
import json
import sys

sys.path.insert(0, str(Path(__file__).parent.parent.parent.parent))

from extended.privesc.kernel_exploits import KernelExploitDB


class TestKernelExploitDB:
    """Test suite for KernelExploitDB class."""

    @pytest.fixture
    def db(self):
        """Create KernelExploitDB instance."""
        return KernelExploitDB()

    def test_init(self, db):
        """Test initialization."""
        assert db is not None
        assert hasattr(db, 'search')
        assert hasattr(db, 'get_by_cve')

    def test_load_database(self, db):
        """Test database loading."""
        exploits = db._load_database()
        assert isinstance(exploits, dict)
        assert 'windows' in exploits
        assert 'linux' in exploits

    def test_search_windows_exploits(self, db):
        """Test Windows exploit search."""
        results = db.search('windows', 'Windows 10 1909')
        assert isinstance(results, list)

    def test_search_linux_exploits(self, db):
        """Test Linux exploit search."""
        results = db.search('linux', 'Ubuntu 20.04')
        assert isinstance(results, list)

    def test_get_by_cve(self, db):
        """Test exploit lookup by CVE."""
        with patch.object(db, '_load_database') as mock_load:
            mock_load.return_value = {
                'windows': [
                    {
                        'cve': 'CVE-2021-1732',
                        'name': 'Win32k Elevation of Privilege',
                        'severity': 'high'
                    }
                ]
            }

            result = db.get_by_cve('CVE-2021-1732')
            assert result is not None
            assert result['cve'] == 'CVE-2021-1732'

    def test_get_by_cve_not_found(self, db):
        """Test CVE lookup with no match."""
        with patch.object(db, '_load_database') as mock_load:
            mock_load.return_value = {'windows': [], 'linux': []}

            result = db.get_by_cve('CVE-9999-9999')
            assert result is None

    def test_filter_by_severity(self, db):
        """Test filtering exploits by severity."""
        exploits = [
            {'cve': 'CVE-1', 'severity': 'critical'},
            {'cve': 'CVE-2', 'severity': 'high'},
            {'cve': 'CVE-3', 'severity': 'medium'}
        ]

        result = db.filter_by_severity(exploits, 'critical')
        assert len(result) == 1
        assert result[0]['cve'] == 'CVE-1'

    def test_filter_by_exploit_available(self, db):
        """Test filtering by exploit availability."""
        exploits = [
            {'cve': 'CVE-1', 'exploit_available': True},
            {'cve': 'CVE-2', 'exploit_available': False}
        ]

        result = db.filter_by_exploit_available(exploits, True)
        assert len(result) == 1
        assert result[0]['cve'] == 'CVE-1'

    def test_version_matches_simple(self, db):
        """Test simple version matching."""
        assert db._version_matches('Windows 10 1909', 'Windows 10 1909') is True
        assert db._version_matches('Windows 10 1909', 'Windows 10 2004') is False

    def test_version_matches_range(self, db):
        """Test version range matching."""
        assert db._version_matches('Windows 10 1909', 'Windows 10 1809-2004') is True
        assert db._version_matches('Ubuntu 20.04', 'Ubuntu 20.04') is True

    def test_add_exploit(self, db, tmp_path):
        """Test adding new exploit to database."""
        db.db_path = tmp_path / 'test_db.json'

        new_exploit = {
            'cve': 'CVE-2024-9999',
            'name': 'Test Exploit',
            'versions': ['Windows 11'],
            'severity': 'high',
            'exploit_available': True,
            'references': ['https://example.com']
        }

        result = db.add_exploit('windows', new_exploit)
        assert result is True

    def test_export_database(self, db, tmp_path):
        """Test exporting database to file."""
        output_file = tmp_path / 'export.json'

        result = db.export_database(str(output_file))
        assert result is True
        assert output_file.exists()

    def test_get_statistics(self, db):
        """Test database statistics."""
        with patch.object(db, '_load_database') as mock_load:
            mock_load.return_value = {
                'windows': [
                    {'cve': 'CVE-1', 'severity': 'critical'},
                    {'cve': 'CVE-2', 'severity': 'high'}
                ],
                'linux': [
                    {'cve': 'CVE-3', 'severity': 'high'}
                ]
            }

            stats = db.get_statistics()
            assert stats['total'] == 3
            assert stats['windows'] == 2
            assert stats['linux'] == 1

    def test_search_by_keyword(self, db):
        """Test keyword search in exploit names."""
        with patch.object(db, '_load_database') as mock_load:
            mock_load.return_value = {
                'windows': [
                    {'cve': 'CVE-1', 'name': 'Win32k Elevation'},
                    {'cve': 'CVE-2', 'name': 'NTLM Privilege Escalation'}
                ]
            }

            results = db.search_by_keyword('win32k')
            assert len(results) == 1
            assert results[0]['cve'] == 'CVE-1'

    def test_get_latest_exploits(self, db):
        """Test getting latest exploits."""
        with patch.object(db, '_load_database') as mock_load:
            mock_load.return_value = {
                'windows': [
                    {'cve': 'CVE-2024-0001', 'name': 'Test 1'},
                    {'cve': 'CVE-2023-0001', 'name': 'Test 2'},
                    {'cve': 'CVE-2024-0002', 'name': 'Test 3'}
                ]
            }

            results = db.get_latest_exploits(limit=2)
            assert len(results) == 2
            assert 'CVE-2024' in results[0]['cve']

    def test_validate_exploit_entry(self, db):
        """Test exploit entry validation."""
        valid_exploit = {
            'cve': 'CVE-2024-0001',
            'name': 'Test Exploit',
            'versions': ['Windows 11'],
            'severity': 'high',
            'exploit_available': True,
            'references': ['https://example.com']
        }

        assert db._validate_exploit_entry(valid_exploit) is True

    def test_validate_exploit_entry_invalid(self, db):
        """Test exploit entry validation with invalid data."""
        invalid_exploit = {
            'cve': 'CVE-2024-0001',
            'name': 'Test Exploit'
            # Missing required fields
        }

        assert db._validate_exploit_entry(invalid_exploit) is False
